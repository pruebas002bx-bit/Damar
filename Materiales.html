<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Materiales - DAMAR</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        :root {
            --primary-dark: #2C3E50; --secondary-light: #ECF0F1; --accent: #3498DB;
            --text-dark: #34495E; --success: #27AE60; --danger: #E74C3C;
            --border-color: #dfe4ea; --gradient-primary: linear-gradient(135deg, #667eea, #764ba2);
            --shadow: 0 10px 30px rgba(44, 62, 80, 0.1); --font-family: 'Poppins', sans-serif;
            --border-radius-lg: 12px; --border-radius-md: 8px;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: var(--font-family); background-color: var(--secondary-light); color: var(--text-dark); }
        .container { max-width: 1400px; margin: 2rem auto; padding: 0 1.5rem; }
        .card { background: white; border-radius: var(--border-radius-lg); padding: 2rem; box-shadow: var(--shadow); margin-bottom: 2rem; }
        .header { text-align: center; margin-bottom: 2.5rem; }
        .title { font-size: 2.5rem; font-weight: 700; color: var(--primary-dark); }
        .subtitle { font-size: 1.1rem; color: var(--text-dark); max-width: 600px; margin: 0.5rem auto 0; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1.5rem; }
        .form-group { display: flex; flex-direction: column; }
        .form-label { font-weight: 600; margin-bottom: 0.6rem; color: var(--primary-dark); font-size: 0.9rem; }
        .form-input { width: 100%; padding: 12px 16px; border: 1px solid var(--border-color); border-radius: var(--border-radius-md); font-size: 1rem; transition: all 0.3s ease; }
        .form-input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.15); }
        .buttons-container { display: flex; flex-wrap: wrap; gap: 1rem; margin-top: 2rem; border-top: 1px solid var(--border-color); padding-top: 2rem; }
        .btn { border: none; border-radius: var(--border-radius-md); padding: 12px 24px; font-size: 0.95rem; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 0.75rem; transition: all 0.3s ease; text-transform: uppercase; }
        .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 15px 35px rgba(44, 62, 80, 0.15); }
        .btn:disabled { background-color: #bdc3c7; cursor: not-allowed; opacity: 0.6; }
        .btn-primary { background: var(--gradient-primary); color: white; }
        .btn-danger { background-color: var(--danger); color: white; }
        .btn-secondary { background-color: var(--secondary-light); color: var(--text-dark); border: 1px solid var(--border-color); }
        .table-container { overflow-x: auto; }
        .data-table { width: 100%; border-collapse: collapse; text-align: left; }
        .data-table th, .data-table td { padding: 14px 18px; vertical-align: middle; border-bottom: 1px solid var(--border-color); white-space: nowrap; }
        .data-table thead th { background-color: #f8f9fa; color: var(--primary-dark); font-size: 13px; font-weight: 600; text-transform: uppercase; }
        .data-table tbody tr:hover { background-color: #f5f5f5; cursor: pointer; }
        .data-table tr.selected { background-color: rgba(52, 152, 219, 0.1) !important; box-shadow: inset 4px 0 0 0 var(--accent); }
        .feedback-state { text-align: center; padding: 4rem 1rem; font-size: 1.1rem; color: #6c757d; }
        .feedback-state i { font-size: 2.5rem; display: block; margin-bottom: 1rem; color: var(--accent); }
        .loading-spinner { width: 50px; height: 50px; border: 4px solid var(--border-color); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 1050; }
        .toast { display: flex; align-items: center; padding: 15px 20px; border-radius: var(--border-radius-md); color: white; font-weight: 500; margin-bottom: 10px; box-shadow: var(--shadow); transform: translateX(120%); animation: slideIn 0.5s forwards; }
        .toast.success { background-color: var(--success); }
        .toast.error { background-color: var(--danger); }
        @keyframes slideIn { to { transform: translateX(0); } }
    </style>
</head>
<body>
    <div id="toastContainer" class="toast-container"></div>
    <div class="container">
        <header class="header">
            <h1 class="title">Gestión de Materiales</h1>
            <p class="subtitle">Añada, edite o elimine los materiales utilizados en la producción.</p>
        </header>
        <main>
            <section class="card">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="nameInput" class="form-label">Nombre del Material</label>
                        <input type="text" id="nameInput" class="form-input" placeholder="Ej: Hilo Calibre 75">
                    </div>
                    <div class="form-group">
                        <label for="priceInput" class="form-label">Precio (COP)</label>
                        <input type="text" id="priceInput" class="form-input" placeholder="Ej: 15000">
                    </div>
                </div>
                <div class="buttons-container">
                    <button id="addBtn" class="btn btn-primary"><i class="fa-solid fa-plus"></i> Agregar</button>
                    <button id="updateBtn" class="btn btn-primary" style="display: none;"><i class="fa-solid fa-save"></i> Guardar Cambios</button>
                    <button id="deleteBtn" class="btn btn-danger"><i class="fa-solid fa-trash"></i> Eliminar</button>
                    <button id="clearBtn" class="btn btn-secondary"><i class="fa-solid fa-eraser"></i> Limpiar</button>
                </div>
            </section>
            <section class="card">
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Nombre del Material</th>
                                <th>Precio</th>
                            </tr>
                        </thead>
                        <tbody id="materialsTableBody"></tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const API_URL = 'https://damar-app.onrender.com/materials';
        let selectedMaterialId = null;

        const nameInput = document.getElementById('nameInput');
        const priceInput = document.getElementById('priceInput');
        const addBtn = document.getElementById('addBtn');
        const updateBtn = document.getElementById('updateBtn');
        const deleteBtn = document.getElementById('deleteBtn');
        const clearBtn = document.getElementById('clearBtn');
        const tableBody = document.getElementById('materialsTableBody');
        const allButtons = [addBtn, updateBtn, deleteBtn, clearBtn];

        const formatCurrency = (value) => (parseFloat(value) || 0).toLocaleString('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 });
        const parseCurrency = (value) => String(value).replace(/[^0-9,]/g, '').replace(',', '.');

        const showToast = (message, type = 'success') => {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<i class="fa-solid fa-check-circle" style="margin-right: 10px;"></i> ${message}`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        };

        const setLoading = (isLoading) => allButtons.forEach(btn => btn.disabled = isLoading);

        async function apiRequest(endpoint = '', method = 'GET', data = null) {
            setLoading(true);
            try {
                const options = {
                    method,
                    headers: { 'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true' },
                    mode: 'cors'
                };
                if (data) options.body = JSON.stringify(data);
                const response = await fetch(`${API_URL}${endpoint}`, options);
                if (response.status === 204) return null; // No content on delete
                const responseData = await response.json();
                if (!response.ok) throw new Error(responseData.message || 'Error en la operación');
                return responseData;
            } catch (error) {
                showToast(error.message, 'error');
                throw error;
            } finally {
                setLoading(false);
            }
        }

        const renderTable = (materials = []) => {
            tableBody.innerHTML = '';
            if (materials.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="2" class="feedback-state"><i class="fa-solid fa-box-open"></i> No hay materiales.</td></tr>`;
                return;
            }
            materials.forEach(material => {
                const tr = document.createElement('tr');
                tr.dataset.id = material.id;
                tr.innerHTML = `<td>${material.nombre}</td><td>${formatCurrency(material.precio)}</td>`;
                tr.addEventListener('click', () => selectMaterial(material, tr));
                tableBody.appendChild(tr);
            });
        };

        const loadMaterials = async () => {
            tableBody.innerHTML = `<tr><td colspan="2" class="feedback-state"><div class="loading-spinner"></div></td></tr>`;
            try {
                const response = await apiRequest();
                renderTable(response.materials); // Access the list inside the 'materials' key
            } catch (error) {
                 tableBody.innerHTML = `<tr><td colspan="2" class="feedback-state"><i class="fa-solid fa-circle-exclamation"></i> Error al cargar.</td></tr>`;
            }
        };

        const clearForm = () => {
            selectedMaterialId = null;
            nameInput.value = '';
            priceInput.value = '';
            addBtn.style.display = 'inline-flex';
            updateBtn.style.display = 'none';
            document.querySelectorAll('.data-table tr.selected').forEach(r => r.classList.remove('selected'));
        };

        const selectMaterial = (material, row) => {
            selectedMaterialId = material.id;
            nameInput.value = material.nombre;
            priceInput.value = parseFloat(material.precio) || 0;
            addBtn.style.display = 'none';
            updateBtn.style.display = 'inline-flex';
            document.querySelectorAll('.data-table tr.selected').forEach(r => r.classList.remove('selected'));
            row.classList.add('selected');
        };

        addBtn.addEventListener('click', async () => {
            const nombre = nameInput.value.trim();
            const precio = parseFloat(priceInput.value) || 0;
            if (!nombre) return showToast('El nombre es obligatorio.', 'error');
            await apiRequest('', 'POST', { nombre, precio });
            showToast('Material agregado.');
            clearForm();
            loadMaterials();
        });

        updateBtn.addEventListener('click', async () => {
            const nombre = nameInput.value.trim();
            const precio = parseFloat(priceInput.value) || 0;
            if (!selectedMaterialId || !nombre) return showToast('Seleccione un material y complete el nombre.', 'error');
            await apiRequest(`/${selectedMaterialId}`, 'PUT', { nombre, precio });
            showToast('Material actualizado.');
            clearForm();
            loadMaterials();
        });

        deleteBtn.addEventListener('click', async () => {
            if (!selectedMaterialId) return showToast('Seleccione un material.', 'error');
            if (confirm(`¿Eliminar "${nameInput.value}"?`)) {
                await apiRequest(`/${selectedMaterialId}`, 'DELETE');
                showToast('Material eliminado.');
                clearForm();
                loadMaterials();
            }
        });

        clearBtn.addEventListener('click', clearForm);
        loadMaterials();
    });
    </script>
</body>
</html>
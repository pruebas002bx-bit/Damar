<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - DAMAR</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    
    <style>
        :root {
            --primary-dark: #2C3E50; --secondary-light: #f4f7f9; --accent: #3498DB;
            --text-dark: #34495E; --text-light: white; --hover-accent: #2980B9;
            --success: #27AE60; --warning: #F39C12; --danger: #E74C3C;
            --info: #9B59B6; --inventory-fabrics: #1ABC9C; --inventory-materials: #16A085;
            --production: #E67E22; --cuts: #8E44AD;
            --border-color: #dfe4ea; --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --shadow: 0 10px 30px rgba(44, 62, 80, 0.08);
            --font-family: 'Poppins', sans-serif;
            --border-radius-lg: 16px;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: var(--font-family); background-color: var(--secondary-light); color: var(--text-dark); animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .container { padding: 2rem; max-width: 1800px; margin: 0 auto; }
        
        .dashboard-grid {
            display: grid;
            gap: 1.5rem;
            grid-template-columns: repeat(12, 1fr);
        }
        
        .kpi-card {
            grid-column: span 3;
            background: white;
            padding: 1.5rem;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 1.5rem;
            border-left: 5px solid var(--accent);
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
        }
        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(44, 62, 80, 0.12);
        }
        .kpi-card .icon-wrapper {
            font-size: 1.8rem;
            padding: 1.2rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .kpi-card .kpi-value { font-size: 2rem; font-weight: 700; color: var(--primary-dark); }
        .kpi-card .kpi-title { font-size: 0.95rem; color: #6c757d; font-weight: 500; }
        
        .kpi-card.sales { border-color: var(--success); }
        .kpi-card.sales .icon-wrapper { color: var(--success); background-color: #eafaf1; }
        
        .kpi-card.client-debt { border-color: var(--danger); }
        .kpi-card.client-debt .icon-wrapper { color: var(--danger); background-color: #fceeee; }

        .kpi-card.supplier-debt { border-color: var(--warning); }
        .kpi-card.supplier-debt .icon-wrapper { color: var(--warning); background-color: #fef8e7; }
        
        /* NUEVOS ESTILOS KPI */
        .kpi-card.inventory-fabrics { border-color: var(--inventory-fabrics); }
        .kpi-card.inventory-fabrics .icon-wrapper { color: var(--inventory-fabrics); background-color: #e8f8f5; }

        .kpi-card.inventory-materials { border-color: var(--inventory-materials); }
        .kpi-card.inventory-materials .icon-wrapper { color: var(--inventory-materials); background-color: #e8f6f3; }
        
        .kpi-card.cuts { border-color: var(--cuts); }
        .kpi-card.cuts .icon-wrapper { color: var(--cuts); background-color: #f3eef7; }

        .kpi-card.production { border-color: var(--production); }
        .kpi-card.production .icon-wrapper { color: var(--production); background-color: #fdf2e8; }

        .kpi-card.employees { border-color: var(--info); }
        .kpi-card.employees .icon-wrapper { color: var(--info); background-color: #f4eef7; }
        
        .chart-card {
            background: white;
            padding: 2rem;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow);
            position: relative;
            min-height: 400px;
            display: flex;
            flex-direction: column;
        }
        .chart-card h2 { font-size: 1.4rem; margin-bottom: 1.5rem; color: var(--primary-dark); font-weight: 600; }
        .chart-container { position: relative; flex-grow: 1; }

        .line-chart-card { grid-column: span 12; }
        .bar-chart-card { grid-column: span 6; }
        .pie-chart-card { grid-column: span 6; }
        
        .loader-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.8);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 10;
        }
        .loading-spinner { width: 40px; height: 40px; border: 4px solid var(--border-color); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .error-message { text-align: center; color: var(--danger); font-weight: 500;}
        .error-message i { font-size: 1.5rem; display: block; margin-bottom: 0.5rem; }

        @media (max-width: 1600px) {
            .kpi-card { grid-column: span 4; }
        }
        @media (max-width: 1200px) {
            .kpi-card { grid-column: span 6; }
            .bar-chart-card, .pie-chart-card { grid-column: span 12; }
        }
        @media (max-width: 768px) {
            .kpi-card { grid-column: span 12; }
            .container { padding: 1rem; }
        }
    </style>
</head>
<body>

    <div class="container">
        <div id="mainLoader" class="loader-overlay" style="position: static; height: 80vh; background: none;">
            <div class="loading-spinner" style="width: 50px; height: 50px;"></div>
            <p style="margin-top: 1rem; font-size: 1.2rem; color: #6c757d;">Cargando Dashboard...</p>
        </div>

        <div id="dashboardContent" class="dashboard-grid" style="visibility: hidden;">
            
            <div class="kpi-card sales">
                <div class="icon-wrapper"><i class="fa-solid fa-sack-dollar"></i></div>
                <div><div id="kpiTotalVentas" class="kpi-value">$0</div><div class="kpi-title">Ventas Totales</div></div>
            </div>
            <div class="kpi-card client-debt">
                <div class="icon-wrapper"><i class="fa-solid fa-file-invoice-dollar"></i></div>
                <div><div id="kpiDeudaClientes" class="kpi-value">$0</div><div class="kpi-title">Cartera (Deuda Clientes)</div></div>
            </div>
            <div class="kpi-card supplier-debt">
                <div class="icon-wrapper"><i class="fa-solid fa-receipt"></i></div>
                <div><div id="kpiDeudaProveedores" class="kpi-value">$0</div><div class="kpi-title">Cuentas por Pagar</div></div>
            </div>
            <div class="kpi-card employees">
                <div class="icon-wrapper"><i class="fa-solid fa-users"></i></div>
                <div><div id="kpiTotalEmpleados" class="kpi-value">0</div><div class="kpi-title">Total Empleados</div></div>
            </div>

            <div class="kpi-card cuts">
                <div class="icon-wrapper"><i class="fa-solid fa-scissors"></i></div>
                <div><div id="kpiCortesHoy" class="kpi-value">0</div><div class="kpi-title">Cortes Pendientes Hoy</div></div>
            </div>
            <div class="kpi-card production">
                <div class="icon-wrapper"><i class="fa-solid fa-helmet-safety"></i></div>
                <div><div id="kpiValorProduccion" class="kpi-value">$0</div><div class="kpi-title">Valor en Producción Activa</div></div>
            </div>
            <div class="kpi-card inventory-fabrics"> <div class="icon-wrapper"><i class="fa-solid fa-scroll"></i></div>
                <div><div id="kpiValorInventarioTelas" class="kpi-value">$0</div><div class="kpi-title">Valor Inventario (Telas)</div></div>
            </div>
            <div class="kpi-card inventory-materials"> <div class="icon-wrapper"><i class="fa-solid fa-boxes-stacked"></i></div>
                <div><div id="kpiValorInventarioMateriales" class="kpi-value">$0</div><div class="kpi-title">Valor Inventario (Materiales)</div></div>
            </div>
            
            <div class="chart-card line-chart-card" id="salesTrendCard">
                <h2>Tendencia de Ventas Mensuales</h2>
                <div class="chart-container"><canvas id="salesTrendChart"></canvas></div>
            </div>

            <div class="chart-card bar-chart-card" id="productionSatelliteCard">
                <h2>Producción Asignada por Satélite</h2>
                <div class="chart-container"><canvas id="productionSatelliteChart"></canvas></div>
            </div>
            <div class="chart-card bar-chart-card" id="inventoryBySupplierCard"> <h2>Top Proveedores por Valor en Inventario</h2>
                <div class="chart-container"><canvas id="inventoryBySupplierChart"></canvas></div>
            </div>
            
            <div class="chart-card pie-chart-card" id="cutsStatusCard">
                <h2>Estado de Cortes Programados</h2>
                <div class="chart-container"><canvas id="cutsStatusChart"></canvas></div>
            </div>
             <div class="chart-card bar-chart-card" id="fabricsByValueCard"> <h2>Top 5 Telas por Valor en Inventario</h2>
                <div class="chart-container"><canvas id="fabricsByValueChart"></canvas></div>
            </div>
        </div>
    </div>

    <script>
        (async function() {
            let API_URL = 'http://localhost:8080';
            try {
                if (window.parent && window.parent.API_BASE_URL) {
                    API_URL = window.parent.API_BASE_URL;
                }
            } catch (e) {
                console.warn('No se pudo acceder a window.parent. Usando URL por defecto.');
            }

            const mainLoader = document.getElementById('mainLoader');
            const dashboardContent = document.getElementById('dashboardContent');

            const formatCurrency = (value) => (value || 0).toLocaleString('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 });
            const formatNumber = (value) => (value || 0).toLocaleString('es-CO');
            
            const renderLoader = (cardElement) => {
                const loader = document.createElement('div');
                loader.className = 'loader-overlay';
                loader.innerHTML = '<div class="loading-spinner"></div>';
                cardElement.appendChild(loader);
            };

            const renderError = (cardElement, message = 'No se pudieron cargar los datos.') => {
                const error = document.createElement('div');
                error.className = 'loader-overlay';
                error.innerHTML = `<div class="error-message"><i class="fa-solid fa-circle-xmark"></i>${message}</div>`;
                cardElement.querySelector('.loader-overlay')?.remove();
                cardElement.appendChild(error);
            };

            const removeOverlay = (cardElement) => {
                cardElement.querySelector('.loader-overlay')?.remove();
            };

            const loadKPIs = async () => {
                try {
                    const response = await fetch(`${API_URL}/api/kpis`, { headers: { 'ngrok-skip-browser-warning': 'true' } });
                    if (!response.ok) throw new Error('Error de red en KPIs');
                    const kpis = await response.json();
                    
                    document.getElementById('kpiTotalVentas').textContent = formatCurrency(kpis.total_ventas);
                    document.getElementById('kpiDeudaClientes').textContent = formatCurrency(kpis.deuda_clientes);
                    document.getElementById('kpiDeudaProveedores').textContent = formatCurrency(kpis.deuda_proveedores);
                    document.getElementById('kpiTotalEmpleados').textContent = formatNumber(kpis.total_empleados);
                    document.getElementById('kpiCortesHoy').textContent = formatNumber(kpis.cortes_pendientes_hoy);
                    document.getElementById('kpiValorProduccion').textContent = formatCurrency(kpis.valor_en_produccion);
                    // --- NUEVOS KPIs de Inventario ---
                    document.getElementById('kpiValorInventarioTelas').textContent = formatCurrency(kpis.valor_inventario_telas);
                    document.getElementById('kpiValorInventarioMateriales').textContent = formatCurrency(kpis.valor_inventario_materiales);
                } catch (error) {
                    console.error('Error al cargar KPIs:', error);
                }
            };

            const loadChart = async (cardId, endpoint, chartFn) => {
                const cardElement = document.getElementById(cardId);
                renderLoader(cardElement);
                try {
                    const response = await fetch(`${API_URL}${endpoint}`, { headers: { 'ngrok-skip-browser-warning': 'true' } });
                    if (!response.ok) throw new Error(`Error en ${endpoint}`);
                    const chartData = await response.json();
                    removeOverlay(cardElement);
                    chartFn(chartData);
                } catch (error) {
                    console.error(`Error al cargar ${cardId}:`, error);
                    renderError(cardElement);
                }
            };

            // --- Definiciones de los Gráficos (Existentes y Nuevos) ---
            const defaultBarOptions = { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { callbacks: { label: ctx => `Valor: ${formatCurrency(ctx.raw)}` } } }, scales: { y: { beginAtZero: true, ticks: { callback: value => formatCurrency(value) } } } };
            
            const createSalesTrendChart = (data) => new Chart(document.getElementById('salesTrendChart'), { type: 'line', data: { labels: data.labels, datasets: [{ label: 'Ventas Totales', data: data.data, borderColor: 'var(--success)', backgroundColor: 'rgba(39, 174, 96, 0.1)', fill: true, tension: 0.4 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { callback: value => formatCurrency(value) } } }, plugins: { tooltip: { callbacks: { label: ctx => `Ventas: ${formatCurrency(ctx.raw)}` } } } } });
            const createProductionBySatelliteChart = (data) => new Chart(document.getElementById('productionSatelliteChart'), { type: 'bar', data: { labels: data.labels, datasets: [{ label: 'Valor Asignado', data: data.data, backgroundColor: 'rgba(230, 126, 34, 0.7)', borderColor: 'var(--production)', borderWidth: 1 }] }, options: defaultBarOptions });
            const createCutsStatusChart = (data) => new Chart(document.getElementById('cutsStatusChart'), { type: 'pie', data: { labels: data.labels, datasets: [{ label: 'Cortes', data: data.data, backgroundColor: ['#8E44AD', '#27AE60', '#F39C12'], hoverOffset: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' } } } });
            
            // --- NUEVOS GRÁFICOS ---
            const createFabricsByValueChart = (data) => new Chart(document.getElementById('fabricsByValueChart'), { type: 'bar', data: { labels: data.labels, datasets: [{ label: 'Valor en Inventario', data: data.data, backgroundColor: 'rgba(26, 188, 156, 0.7)', borderColor: 'var(--inventory-fabrics)', borderWidth: 1 }] }, options: { ...defaultBarOptions, indexAxis: 'y' } });
            const createInventoryBySupplierChart = (data) => new Chart(document.getElementById('inventoryBySupplierChart'), { type: 'bar', data: { labels: data.labels, datasets: [{ label: 'Valor Total Comprado', data: data.data, backgroundColor: 'rgba(22, 160, 133, 0.7)', borderColor: 'var(--inventory-materials)', borderWidth: 1 }] }, options: defaultBarOptions });
            
            // --- Ejecución Principal ---
            dashboardContent.style.visibility = 'visible';
            
            await Promise.allSettled([
                loadKPIs(),
                loadChart('salesTrendCard', '/api/charts/sales-trend', createSalesTrendChart),
                loadChart('productionSatelliteCard', '/api/charts/production-by-satellite', createProductionBySatelliteChart),
                loadChart('cutsStatusCard', '/api/charts/cuts-status', createCutsStatusChart),
                // --- NUEVAS LLAMADAS A LA API ---
                loadChart('fabricsByValueCard', '/api/charts/fabrics-by-value', createFabricsByValueChart),
                loadChart('inventoryBySupplierCard', '/api/charts/inventory-by-supplier', createInventoryBySupplierChart)
            ]);
            
            mainLoader.style.display = 'none';

        })();
    </script>
</body>
</html>
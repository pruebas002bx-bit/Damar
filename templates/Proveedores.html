<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Proveedores - DAMAR</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <style>
        :root {
            --primary-dark: #2C3E50;
            --secondary-light: #ECF0F1;
            --accent: #3498DB;
            --text-dark: #34495E;
            --text-light: white;
            --hover-accent: #2980B9;
            --success: #27AE60;
            --warning: #F39C12; /* Naranja */
            --danger: #E74C3C; /* Rojo */
            --border-color: #dfe4ea;
            --gradient-primary: linear-gradient(135deg, #3498DB 0%, #2C3E50 100%);
            --shadow: 0 10px 30px rgba(44, 62, 80, 0.1);
            --shadow-hover: 0 15px 35px rgba(44, 62, 80, 0.15);
            --font-family: 'Poppins', sans-serif;
            --border-radius-lg: 12px;
            --border-radius-md: 8px;
        }

        /* --- Estilos Generales --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; }
        body {
            font-family: var(--font-family);
            background-color: var(--secondary-light);
            color: var(--text-dark);
            line-height: 1.6;
            animation: fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- Contenedores y Tarjetas --- */
        .container { max-width: 1400px; margin: 2rem auto; padding: 0 1.5rem; }
        .card {
            background-color: white;
            border-radius: var(--border-radius-lg);
            padding: 2.5rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        /* --- Encabezado --- */
        .content-header { text-align: center; margin-bottom: 2.5rem; }
        .content-title { font-size: 2.5rem; font-weight: 700; color: var(--primary-dark); margin-bottom: 0.5rem; }
        .content-subtitle { font-size: 1.1rem; color: var(--text-dark); max-width: 700px; margin: 0 auto; }

        /* --- Formularios --- */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.5rem 2rem;
        }
        .form-group { display: flex; flex-direction: column; }
        .form-label { font-weight: 600; margin-bottom: 0.6rem; color: var(--primary-dark); font-size: 0.9rem; }
        .form-input {
            width: 100%; padding: 12px 16px; border: 1px solid var(--border-color);
            border-radius: var(--border-radius-md); background-color: #fdfdfe; color: var(--text-dark);
            font-size: 1rem; font-family: var(--font-family); transition: all 0.3s ease;
        }
        .form-input:focus {
            outline: none; border-color: var(--accent); background-color: white;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.15);
        }
        
        .info-display { font-size: 1.5rem; font-weight: 700; background-color: var(--secondary-light); border-radius: var(--border-radius-md);
            text-align: left; height: 100%; display: flex; align-items: center; justify-content: flex-start; padding: 0 1rem;
            border: 1px solid var(--border-color); }
        .pdf-info-group { display: flex; align-items: center; gap: 1rem; }
        #pdfInfo { font-size: 0.9rem; color: #6c757d; font-style: italic; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* --- Botones --- */
        .buttons-container { display: flex; flex-wrap: wrap; gap: 1rem; margin-top: 2rem; border-top: 1px solid var(--border-color); padding-top: 2rem; }
        .btn {
            border: none; border-radius: var(--border-radius-md); padding: 12px 24px;
            font-size: 0.95rem; font-weight: 600; font-family: var(--font-family);
            cursor: pointer; display: inline-flex; align-items: center; justify-content: center;
            gap: 0.75rem; transition: all 0.3s ease; text-transform: uppercase;
            letter-spacing: 0.5px; box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: var(--shadow-hover); }
        .btn-primary { background: var(--gradient-primary); color: white; }
        .btn-success { background-color: var(--success); color: white; }
        .btn-danger { background-color: var(--danger); color: white; }
        .btn-secondary { background-color: var(--secondary-light); color: var(--text-dark); border: 1px solid var(--border-color); }

        /* --- Búsqueda y Filtros --- */
        .search-controls { display: flex; gap: 1rem; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; }
        .search-wrapper { position: relative; flex-grow: 1; }
        .search-icon { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: #909db1; }
        .search-input { width: 100%; padding-left: 3rem; }
        
        /* --- Tabla de Datos --- */
        .table-container { overflow-x: auto; }
        .data-table { width: 100%; border-collapse: collapse; text-align: left; }
        .data-table th, .data-table td {
            padding: 14px 18px; vertical-align: middle; border-bottom: 1px solid var(--border-color); white-space: nowrap;
        }
        .data-table thead th { background-color: #f8f9fa; color: var(--primary-dark); font-size: 13px; font-weight: 600;
            text-transform: uppercase; letter-spacing: 0.5px; }
        .data-table tbody tr { transition: background-color 0.2s ease; }
        .data-table tbody tr:hover { background-color: #f5f5f5; cursor: pointer; }
        .data-table tr.selected { background-color: rgba(52, 152, 219, 0.1) !important; box-shadow: inset 4px 0 0 0 var(--accent); }
        
        .checkbox-cell { text-align: center; }
        .status-badge { padding: 4px 10px; border-radius: 50px; color: white; font-weight: 600; font-size: 0.8rem; text-align: center; }
        .status-pagado { background-color: var(--success); }
        .status-vencido { background-color: var(--danger); }
        .status-por-vencer { background-color: var(--warning); color: var(--text-dark) }
        .status-pendiente { background-color: var(--accent); }
        .pdf-link { text-decoration: none; color: var(--accent); font-weight: 600; }
        .pdf-link:hover { text-decoration: underline; color: var(--hover-accent); }

        .feedback-state { text-align: center; padding: 4rem 1rem; font-size: 1.1rem; color: #6c757d; }
        .feedback-state i { font-size: 2.5rem; display: block; margin-bottom: 1rem; color: var(--accent); }
        
        /* --- Sección de Totales --- */
        .totals-section {
            display: none; /* Oculto por defecto */
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            background-color: #f8f9fa;
            padding: 1.5rem 2rem;
            border-radius: var(--border-radius-lg);
            margin-top: 2rem;
            border: 1px solid var(--border-color);
            animation: fadeIn 0.4s;
        }
        .totals-section.visible {
            display: grid;
        }
        .total-item {
            background-color: white;
            padding: 1rem;
            border-radius: var(--border-radius-md);
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            border-left: 4px solid var(--primary-dark);
        }
        .total-item .label {
            display: block;
            font-size: 0.9rem;
            font-weight: 600;
            color: #6c757d;
            margin-bottom: 0.5rem;
        }
        .total-item .value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-dark);
        }
        .total-item.saldo .value {
            color: var(--danger);
        }
        .total-item.abono .value {
            color: var(--success);
        }

        @media (max-width: 768px) {
            .container { margin: 1rem auto; padding: 0 1rem; }
            .card { padding: 1.5rem; }
            .content-title { font-size: 2rem; }
            .buttons-container { flex-direction: column; }
            .btn { width: 100%; }
            .search-controls { flex-direction: column; align-items: stretch; }
        }
    </style>
</head>
<body>

    <div class="container">
        <header class="content-header">
            <h1 class="content-title">Gestión de Proveedores y Facturas</h1>
            <p class="content-subtitle">Administra facturas de proveedores, controla pagos, saldos y fechas de vencimiento de forma eficiente.</p>
        </header>
        
        <main>
            <section class="card">
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label" for="fechaInput">Fecha</label>
                        <input type="date" id="fechaInput" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="facturaInput">Nº Factura</label>
                        <input type="text" id="facturaInput" class="form-input" placeholder="Número de factura">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="vencimientoInput">Vencimiento</label>
                        <input type="date" id="vencimientoInput" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="proveedorInput">Proveedor</label>
                        <input type="text" id="proveedorInput" class="form-input" placeholder="Nombre del proveedor">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="telaInput">Tela/Material</label>
                        <input type="text" id="telaInput" class="form-input" placeholder="Descripción del material">
                    </div>
                     <div class="form-group">
                        <label class="form-label" for="valorInput">Valor Total (COP)</label>
                        <input type="number" id="valorInput" class="form-input" placeholder="0.00" step="0.01">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="abonoInput">Abono (COP)</label>
                        <input type="number" id="abonoInput" class="form-input" placeholder="0.00" step="0.01">
                    </div>
                    <div class="form-group">
                         <label class="form-label">Saldo Pendiente</label>
                        <div id="saldoDisplay" class="info-display" style="color: var(--danger);">$0.00</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Factura PDF</label>
                        <div class="pdf-info-group">
                            <label for="pdfInput" class="btn btn-secondary" style="padding: 12px 16px;">
                                <i class="fa-solid fa-upload"></i> Seleccionar...
                            </label>
                            <input type="file" id="pdfInput" accept=".pdf" style="display:none;">
                            <span id="pdfInfo">Ningún archivo</span>
                        </div>
                    </div>
                </div>

                <div style="grid-column: 1 / -1; margin-top: 2rem; border-top: 1px solid var(--border-color); padding-top: 2rem;">
                    <h3 style="color: var(--primary-dark); margin-bottom: 1rem;">Registrar Abono o Nota a Factura Seleccionada</h3>
                    <div class="form-grid">
                        <div class="form-group" style="grid-column: span 2;">
                            <label class="form-label" for="observacionInput">Nueva Observación o Nota</label>
                            <textarea id="observacionInput" class="form-input" placeholder="Añadir una nota sobre el pago, la factura, etc." rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="nuevoAbonoInput">Abonar a Saldo (COP)</label>
                            <input type="number" id="nuevoAbonoInput" class="form-input" placeholder="0.00">
                        </div>
                        <div class="form-group" style="justify-content: flex-end;">
                            <button id="addNoteBtn" class="btn btn-primary" style="background: var(--accent);"><i class="fa-solid fa-comment-dots"></i> Registrar Abono/Nota</button>
                        </div>
                    </div>
                </div>
        
                <div class="buttons-container">
                    <button id="addBtn" class="btn btn-primary"><i class="fa-solid fa-plus"></i> Registrar Factura</button>
                    <button id="editBtn" class="btn btn-success"><i class="fa-solid fa-floppy-disk"></i> Guardar Cambios</button>
                    <button id="deleteBtn" class="btn btn-danger"><i class="fa-solid fa-trash-can"></i> Eliminar Seleccionados</button>
                    <button id="clearBtn" class="btn btn-secondary"><i class="fa-solid fa-eraser"></i> Limpiar Campos</button>
                </div>
            </section>
            
            <section class="card">
                <div class="search-controls">
                    <div class="search-wrapper">
                        <i class="fa-solid fa-magnifying-glass search-icon"></i>
                        <input type="text" id="searchInput" class="form-input search-input" placeholder="Buscar por Proveedor, Factura, Tela...">
                    </div>
                    <button id="clearSearchBtn" class="btn btn-secondary">
                        <i class="fa-solid fa-xmark"></i> Limpiar Filtro
                    </button>
                </div>
                
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th class="checkbox-cell"><input type="checkbox" id="selectAllCheckbox"></th>
                                <th>Fecha</th>
                                <th>Proveedor</th>
                                <th>N° Factura</th>
                                <th>Tela/Material</th>
                                <th>Valor</th>
                                <th>Abono</th>
                                <th>Saldo</th>
                                <th>Vencimiento</th>
                                <th>Estado</th>
                                <th>PDF</th>
                            </tr>
                        </thead>
                        <tbody id="proveedoresTableBody">
                        </tbody>
                    </table>
                </div>

                <div id="totalsSection" class="totals-section">
                    <div class="total-item">
                        <span class="label">Total Valor Seleccionado</span>
                        <span id="totalValor" class="value">$0.00</span>
                    </div>
                    <div class="total-item abono">
                        <span class="label">Total Abono Seleccionado</span>
                        <span id="totalAbono" class="value">$0.00</span>
                    </div>
                    <div class="total-item saldo">
                        <span class="label">Total Saldo Seleccionado</span>
                        <span id="totalSaldo" class="value">$0.00</span>
                    </div>
                </div>
            </section>

            <section class="card">
                <h2 style="color: var(--primary-dark); margin-bottom: 1.5rem; text-align: center;">Historial de Actividad de Facturas</h2>
                <div class="table-container" style="max-height: 400px;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Fecha y Hora</th>
                                <th>Proveedor</th>
                                <th>N° Factura</th>
                                <th>Tipo de Evento</th>
                                <th>Detalle / Observación</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody">
                            </tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        let API_URL = 'https://harvey-unspoilt-judie.ngrok-free.dev'; 
        try {
            if (window.parent && window.parent.API_BASE_URL) {
                API_URL = window.parent.API_BASE_URL;
            }
        } catch (e) {
            console.warn('No se pudo acceder a window.parent. Usando URL por defecto.');
        }

        const CLOUDINARY_URL = 'https://api.cloudinary.com/v1_1/dlogpuc3w/upload';
        const CLOUDINARY_UPLOAD_PRESET = 'Documentos';
        const CLOUDINARY_FOLDER = 'Facturas';

        let proveedoresData_local = [];
        let selectedRecordId = null;
        let pdfUrlToSave = null;

        const dom = {
            fechaInput: document.getElementById('fechaInput'),
            facturaInput: document.getElementById('facturaInput'),
            vencimientoInput: document.getElementById('vencimientoInput'),
            proveedorInput: document.getElementById('proveedorInput'),
            telaInput: document.getElementById('telaInput'),
            valorInput: document.getElementById('valorInput'),
            abonoInput: document.getElementById('abonoInput'),
            saldoDisplay: document.getElementById('saldoDisplay'),
            pdfInput: document.getElementById('pdfInput'),
            pdfInfo: document.getElementById('pdfInfo'),
            tableBody: document.getElementById('proveedoresTableBody'),
            searchInput: document.getElementById('searchInput'),
            addBtn: document.getElementById('addBtn'),
            editBtn: document.getElementById('editBtn'),
            deleteBtn: document.getElementById('deleteBtn'),
            clearBtn: document.getElementById('clearBtn'),
            clearSearchBtn: document.getElementById('clearSearchBtn'),
            selectAllCheckbox: document.getElementById('selectAllCheckbox'),
            totalsSection: document.getElementById('totalsSection'),
            totalValor: document.getElementById('totalValor'),
            totalAbono: document.getElementById('totalAbono'),
            totalSaldo: document.getElementById('totalSaldo'),
            observacionInput: document.getElementById('observacionInput'),
            nuevoAbonoInput: document.getElementById('nuevoAbonoInput'),
            addNoteBtn: document.getElementById('addNoteBtn'),
            historyTableBody: document.getElementById('historyTableBody'),
        };

        const formatCurrency = (value) => `$${(parseFloat(value) || 0).toLocaleString('es-CO', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

        function calculateSaldoLive() {
            const valor = parseFloat(dom.valorInput.value) || 0;
            const abono = parseFloat(dom.abonoInput.value) || 0;
            const saldo = valor - abono;
            dom.saldoDisplay.textContent = formatCurrency(saldo);
            
            if (saldo > 0) dom.saldoDisplay.style.color = 'var(--danger)';
            else if (saldo === 0) dom.saldoDisplay.style.color = 'var(--success)';
            else dom.saldoDisplay.style.color = 'var(--accent)';
        }

        function collectFormData() {
            const proveedor = dom.proveedorInput.value.trim();
            const factura = dom.facturaInput.value.trim();
            const tela = dom.telaInput.value.trim();

            if (!proveedor || !factura || !tela || !dom.fechaInput.value) {
                alert("Los campos Fecha, Proveedor, Nº Factura y Tela/Material son obligatorios.");
                return null;
            }
            
            return {
                fecha: dom.fechaInput.value,
                proveedor,
                factura,
                vencimiento: dom.vencimientoInput.value,
                tela,
                valor: parseFloat(dom.valorInput.value) || 0,
                abono: parseFloat(dom.abonoInput.value) || 0,
                pdf_path: pdfUrlToSave
            };
        }
        
        function clearForm() {
            selectedRecordId = null;
            pdfUrlToSave = null;
            dom.tableBody.querySelectorAll('tr.selected').forEach(row => row.classList.remove('selected'));
            
            const today = new Date();
            const thirtyDaysFromNow = new Date();
            thirtyDaysFromNow.setDate(today.getDate() + 30);
            
            dom.fechaInput.valueAsDate = today;
            dom.vencimientoInput.valueAsDate = thirtyDaysFromNow;
            
            dom.proveedorInput.value = '';
            dom.facturaInput.value = '';
            dom.telaInput.value = '';
            dom.valorInput.value = '';
            dom.abonoInput.value = '';
            dom.pdfInput.value = '';
            dom.pdfInfo.textContent = 'Ningún archivo';
            
            calculateSaldoLive();
        }
        
        async function apiRequest(endpoint, method = 'GET', data = null) {
            try {
                const options = {
                    method,
                    headers: { 'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true' },
                    mode: 'cors',
                };
                if (data) options.body = JSON.stringify(data);
                
                const response = await fetch(`${API_URL}${endpoint}`, options);
                const responseData = await response.json();
                if (!response.ok) throw new Error(responseData.message || `Error ${response.status}`);
                return responseData;
            } catch (error) {
                alert(`Error en la comunicación: ${error.message}`);
                throw error;
            }
        }

       // Renderiza la tabla del historial con los datos que recibe del servidor
        function renderHistoryTable(log = []) {
            dom.historyTableBody.innerHTML = '';
            if (log.length === 0) {
                dom.historyTableBody.innerHTML = `<tr><td colspan="5" class="feedback-state">No hay actividad registrada.</td></tr>`;
                return;
            }

            log.forEach(entry => {
                const tr = document.createElement('tr');
                const eventDate = new Date(entry.timestamp);
                const formattedDate = `${eventDate.toLocaleDateString('es-CO')} ${eventDate.toLocaleTimeString('es-CO')}`;
                tr.innerHTML = `
                    <td>${formattedDate}</td>
                    <td>${entry.proveedor}</td>
                    <td>${entry.factura}</td>
                    <td>${entry.type}</td>
                    <td>${entry.details}</td>
                `;
                dom.historyTableBody.appendChild(tr);
            });
        }

        // Carga el historial desde el servidor
        async function loadHistory() {
            try {
                const historyData = await apiRequest('/proveedores/history');
                renderHistoryTable(historyData);
            } catch (error) {
                console.error("No se pudo cargar el historial:", error);
                renderTable('error', 'No se pudo cargar el historial.');
            }
        }

        // Añade una nueva entrada al historial enviándola al servidor
        async function addHistoryEntry(type, record, details = '') {
            const newEntry = {
                timestamp: new Date().toISOString(),
                proveedor: record.proveedor,
                factura: record.factura,
                type: type,
                details: details
            };
            try {
                await apiRequest('/proveedores/history', 'POST', newEntry);
            } catch (error) {
                console.error("Error al guardar entrada de historial:", error);
            }
        }

        // --- INICIO DE NUEVO BLOQUE: LÓGICA DEL HISTORIAL ---
        const HISTORY_STORAGE_KEY = 'proveedores_history_log';

        // Obtiene el historial desde localStorage
        function getHistoryLog() {
            try {
                const log = localStorage.getItem(HISTORY_STORAGE_KEY);
                return log ? JSON.parse(log) : [];
            } catch (e) {
                console.error("Error al leer el historial:", e);
                return [];
            }
        }

        // Guarda el historial en localStorage
        function saveHistoryLog(log) {
            try {
                localStorage.setItem(HISTORY_STORAGE_KEY, JSON.stringify(log));
            } catch (e) {
                console.error("Error al guardar el historial:", e);
            }
        }

        // Añade una nueva entrada al historial
        function addHistoryEntry(type, record, details = '') {
            const log = getHistoryLog();
            const newEntry = {
                timestamp: new Date().toISOString(),
                proveedor: record.proveedor,
                factura: record.factura,
                type: type,
                details: details
            };
            log.unshift(newEntry); // Añadir al principio para ver lo más reciente primero
            saveHistoryLog(log);
            renderHistoryTable(); // Actualizar la tabla visualmente
        }

        // Renderiza la tabla del historial
        function renderHistoryTable() {
            const log = getHistoryLog();
            dom.historyTableBody.innerHTML = '';
            if (log.length === 0) {
                dom.historyTableBody.innerHTML = `<tr><td colspan="5" class="feedback-state">No hay actividad registrada.</td></tr>`;
                return;
            }

            log.forEach(entry => {
                const tr = document.createElement('tr');
                const eventDate = new Date(entry.timestamp);
                const formattedDate = `${eventDate.toLocaleDateString('es-CO')} ${eventDate.toLocaleTimeString('es-CO')}`;
                tr.innerHTML = `
                    <td>${formattedDate}</td>
                    <td>${entry.proveedor}</td>
                    <td>${entry.factura}</td>
                    <td>${entry.type}</td>
                    <td>${entry.details}</td>
                `;
                dom.historyTableBody.appendChild(tr);
            });
        }

        async function uploadToCloudinary(file) {
            dom.pdfInfo.textContent = 'Subiendo factura...';
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
            formData.append('folder', CLOUDINARY_FOLDER);

            try {
                const response = await fetch(CLOUDINARY_URL, { method: 'POST', body: formData });
                const data = await response.json();
                if (data.secure_url) {
                    pdfUrlToSave = data.secure_url;
                    dom.pdfInfo.textContent = 'PDF cargado con éxito.';
                } else {
                    throw new Error('No se pudo obtener la URL del archivo desde Cloudinary.');
                }
            } catch (error) {
                console.error('Error al subir a Cloudinary:', error);
                dom.pdfInfo.textContent = 'Error al subir archivo.';
                pdfUrlToSave = null;
            }
        }

        async function loadProveedores() {
            renderTable('loading');
            try {
                const data = await apiRequest('/proveedores');
                proveedoresData_local = data || [];
                filterRecords();
            } catch (error) {
                renderTable('error', 'No se pudieron cargar los proveedores.');
            }
        }

        async function addRecord() {
            const data = collectFormData();
            if (!data) return;
            
            try {
                await apiRequest('/proveedores', 'POST', data);
                await addHistoryEntry('Factura Creada', data, `Valor: ${formatCurrency(data.valor)}`);
                clearForm();
                await loadProveedores();
                await loadHistory(); // Recargar historial
            } catch (error) {}
        }

        async function editRecord() {
            if (selectedRecordId === null) {
                alert('Por favor, seleccione una factura para editar.');
                return;
            }
            const oldRecord = proveedoresData_local.find(p => p.id == selectedRecordId);
            const data = collectFormData();
            if (!data) return;
            
            try {
                await apiRequest(`/proveedores/${selectedRecordId}`, 'PUT', data);

                const abonoAnterior = parseFloat(oldRecord.abono) || 0;
                const abonoNuevo = parseFloat(data.abono) || 0;
                let historyAdded = false;
                if (abonoNuevo > abonoAnterior) {
                    const diferencia = abonoNuevo - abonoAnterior;
                    await addHistoryEntry('Abono Registrado', data, `Se abonó: ${formatCurrency(diferencia)}`);
                    historyAdded = true;
                }
                // Evitar doble registro si solo se hizo un abono
                if (!historyAdded) {
                     await addHistoryEntry('Factura Editada', data, 'Se guardaron cambios en los campos.');
                }
                
                clearForm();
                await loadProveedores();
                await loadHistory(); // Recargar historial
            } catch (error) {}
        }
        
        async function deleteSelectedRecords() {
            const checkedBoxes = dom.tableBody.querySelectorAll('input[type="checkbox"]:checked');
            if (checkedBoxes.length === 0) {
                alert('Por favor, seleccione al menos una factura para eliminar.');
                return;
            }

            if (confirm(`¿Está seguro de que desea eliminar ${checkedBoxes.length} factura(s)?`)) {
                const idsToDelete = Array.from(checkedBoxes).map(cb => cb.dataset.id);
                
                for (const id of idsToDelete) {
                    const record = proveedoresData_local.find(p => p.id == id);
                    if (record) {
                        await addHistoryEntry('Factura Eliminada', record, `Factura N° ${record.factura} eliminada.`);
                    }
                }

                try {
                    await apiRequest('/proveedores', 'DELETE', { ids: idsToDelete });
                    clearForm();
                    await loadProveedores();
                    await loadHistory(); // Recargar historial
                } catch (error) {}
            }
        }

        function updateSelectionTotals() {
            const checkedBoxes = dom.tableBody.querySelectorAll('input[type="checkbox"]:checked');
            
            let totalValor = 0;
            let totalAbono = 0;
            let totalSaldo = 0;

            checkedBoxes.forEach(checkbox => {
                // **CORRECCIÓN:** Usar una comparación no estricta (==) para coincidir texto con número.
                const record = proveedoresData_local.find(p => p.id == checkbox.dataset.id);
                if (record) {
                    totalValor += parseFloat(record.valor) || 0;
                    totalAbono += parseFloat(record.abono) || 0;
                    totalSaldo += (parseFloat(record.valor) || 0) - (parseFloat(record.abono) || 0);
                }
            });

            dom.totalValor.textContent = formatCurrency(totalValor);
            dom.totalAbono.textContent = formatCurrency(totalAbono);
            dom.totalSaldo.textContent = formatCurrency(totalSaldo);

            if (checkedBoxes.length > 0) {
                dom.totalsSection.classList.add('visible');
            } else {
                dom.totalsSection.classList.remove('visible');
            }
        }

        window.selectRecord = (rowElement, id) => {
            selectedRecordId = id;
            const record = proveedoresData_local.find(p => p.id == id); // Usar == por seguridad
            if (!record) return;

            dom.fechaInput.value = record.fecha;
            dom.vencimientoInput.value = record.vencimiento;
            dom.proveedorInput.value = record.proveedor;
            dom.facturaInput.value = record.factura;
            dom.telaInput.value = record.tela;
            dom.valorInput.value = record.valor;
            dom.abonoInput.value = record.abono;
            calculateSaldoLive();

            pdfUrlToSave = record.pdf_path;
            dom.pdfInfo.textContent = record.pdf_path ? 'PDF ya cargado' : 'Ningún archivo';
            
            dom.tableBody.querySelectorAll('tr.selected').forEach(row => row.classList.remove('selected'));
            rowElement.classList.add('selected');
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        function renderTable(state, message = '', data = []) {
            dom.tableBody.innerHTML = '';
            const colspan = 11;

            if (state === 'loading') {
                dom.tableBody.innerHTML = `<tr><td colspan="${colspan}" class="feedback-state"><i class="fa-solid fa-spinner fa-spin"></i> Cargando...</td></tr>`;
                return;
            }
            if (state === 'error') {
                dom.tableBody.innerHTML = `<tr><td colspan="${colspan}" class="feedback-state"><i class="fa-solid fa-circle-exclamation"></i> ${message}</td></tr>`;
                return;
            }
            if (data.length === 0) {
                const emptyMessage = dom.searchInput.value ? 'No se encontraron resultados.' : 'No hay facturas registradas.';
                dom.tableBody.innerHTML = `<tr><td colspan="${colspan}" class="feedback-state"><i class="fa-solid fa-file-invoice-dollar"></i> ${emptyMessage}</td></tr>`;
                return;
            }

            data.forEach(record => {
                const tr = document.createElement('tr');
                tr.dataset.id = record.id;
                tr.onclick = (e) => {
                    if (e.target.type !== 'checkbox' && e.target.tagName !== 'A') {
                         window.selectRecord(tr, record.id);
                    }
                };

                const saldo = record.valor - record.abono;
                const vencimientoDate = new Date(record.vencimiento + 'T00:00:00');
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const diffTime = vencimientoDate - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                let estado, estadoClass;
                if (saldo <= 0) {
                    estado = "Pagado"; estadoClass = "status-pagado";
                } else if (diffDays < 0) {
                    estado = "Vencido"; estadoClass = "status-vencido";
                } else if (diffDays <= 7) {
                    estado = "Por vencer"; estadoClass = "status-por-vencer";
                } else {
                    estado = "Pendiente"; estadoClass = "status-pendiente";
                }
                
                let pdfHtml = 'Sin PDF';
                if (record.pdf_path && typeof record.pdf_path === 'string' && record.pdf_path.startsWith('http')) {
                    const urlParts = record.pdf_path.split('/upload/');
                    const downloadUrl = urlParts.length === 2 ? `${urlParts[0]}/upload/fl_attachment/${urlParts[1]}` : record.pdf_path;
                    pdfHtml = `<a href="${downloadUrl}" target="_blank" class="pdf-link" onclick="(e) => e.stopPropagation()">Descargar</a>`;
                }

                tr.innerHTML = `
                    <td class="checkbox-cell"><input type="checkbox" data-id="${record.id}"></td>
                    <td>${record.fecha}</td>
                    <td>${record.proveedor}</td>
                    <td>${record.factura}</td>
                    <td>${record.tela}</td>
                    <td>${formatCurrency(record.valor)}</td>
                    <td>${formatCurrency(record.abono)}</td>
                    <td>${formatCurrency(saldo)}</td>
                    <td>${record.vencimiento}</td>
                    <td><span class="status-badge ${estadoClass}">${estado}</span></td>
                    <td>${pdfHtml}</td>
                `;

                const checkbox = tr.querySelector('input[type="checkbox"]');
                checkbox.addEventListener('click', (e) => {
                    e.stopPropagation();
                    updateSelectionTotals();
                });

                dom.tableBody.appendChild(tr);
            });
            updateSelectionTotals(); 
        }
        
        function filterRecords() {
            const searchTerm = dom.searchInput.value.toLowerCase().trim();
            const filteredData = searchTerm ? 
                proveedoresData_local.filter(p => 
                    String(p.proveedor).toLowerCase().includes(searchTerm) ||
                    String(p.factura).toLowerCase().includes(searchTerm) ||
                    String(p.tela).toLowerCase().includes(searchTerm)
                ) : proveedoresData_local;
            renderTable('success', '', filteredData);
        }

        function init() {
            dom.addBtn.addEventListener('click', addRecord);
            dom.editBtn.addEventListener('click', editRecord);
            dom.deleteBtn.addEventListener('click', deleteSelectedRecords);
            dom.clearBtn.addEventListener('click', clearForm);
            dom.clearSearchBtn.addEventListener('click', () => { dom.searchInput.value = ''; filterRecords(); });
            dom.selectAllCheckbox.addEventListener('change', (e) => {
                dom.tableBody.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = e.target.checked);
                updateSelectionTotals();
            });

            dom.valorInput.addEventListener('input', calculateSaldoLive);
            dom.abonoInput.addEventListener('input', calculateSaldoLive);
            dom.pdfInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) uploadToCloudinary(file);
            });
            dom.searchInput.addEventListener('input', filterRecords);

            dom.addNoteBtn.addEventListener('click', async () => {
                if (selectedRecordId === null) {
                    alert('Por favor, seleccione una factura de la tabla primero.');
                    return;
                }
                const nota = dom.observacionInput.value.trim();
                const nuevoAbono = parseFloat(dom.nuevoAbonoInput.value) || 0;

                if (!nota && nuevoAbono <= 0) {
                    alert('Debe ingresar una observación o un valor de abono.');
                    return;
                }
                
                const record = proveedoresData_local.find(p => p.id == selectedRecordId);
                let needsEdit = false;

                if (nota) {
                    await addHistoryEntry('Nota Manual', record, nota);
                }
                
                if (nuevoAbono > 0) {
                    const abonoActual = parseFloat(dom.abonoInput.value) || 0;
                    dom.abonoInput.value = abonoActual + nuevoAbono;
                    needsEdit = true;
                }
                
                dom.observacionInput.value = '';
                dom.nuevoAbonoInput.value = '';

                if (needsEdit) {
                    await editRecord();
                } else {
                    await loadHistory();
                }
            });

            clearForm();
            loadProveedores();
            loadHistory(); // Cargar y mostrar el historial al iniciar
        }
        
        init();
    });
    </script>
</body>
</html>
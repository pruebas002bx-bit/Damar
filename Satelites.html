<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Satélites - DAMAR</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root {
            --primary-dark: #2C3E50; --secondary-light: #ECF0F1; --accent: #3498DB;
            --text-dark: #34495E; --text-light: white; --hover-accent: #2980B9;
            --success: #27AE60; --warning: #F39C12; --danger: #E74C3C;
            --border-color: #dfe4ea; --gradient-primary: linear-gradient(135deg, #2C3E50, #1A252F);
            font-family: 'Poppins', sans-serif;
        }

        body { margin: 0; padding: 0; background-color: var(--secondary-light); color: var(--text-dark); }
        .container { max-width: 1600px; margin: 20px auto; padding: 20px; background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); }
        h1, h2 { color: var(--primary-dark); text-align: center; margin-bottom: 25px; }

        .controls { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 20px; align-items: center; justify-content: space-between; }
        .input-group { flex-grow: 1; min-width: 200px; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9em; }
        .form-input, .form-select { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; box-sizing: border-box; transition: border-color 0.3s; }
        .form-input:focus, .form-select:focus { border-color: var(--accent); outline: none; }
        
        .btn { padding: 10px 15px; border-radius: 6px; cursor: pointer; font-weight: 600; transition: background-color 0.3s; border: none; }
        .btn-primary { background: var(--accent); color: var(--text-light); }
        .btn-primary:hover { background: var(--hover-accent); }
        .btn-success { background: var(--success); color: var(--text-light); }
        .btn-success:hover { background: #229954; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-warning:hover { background: #d35400; }

        .table-container { overflow-x: auto; margin-top: 20px; max-height: 500px; }
        .data-table { width: 100%; border-collapse: collapse; min-width: 1200px; }
        .data-table th, .data-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border-color); font-size: 0.9em; }
        .data-table th { background-color: var(--primary-dark); color: var(--text-light); font-weight: 700; position: sticky; top: 0; z-index: 10; }
        .data-table tr:hover { background-color: #f7f9fa; }

        .satellite-group { margin-bottom: 30px; border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; }
        .satellite-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .satellite-header h3 { margin: 0; color: var(--primary-dark); }
        .satellite-header .summary { font-size: 0.95em; }
        
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 30px; border-radius: 10px; width: 90%; max-width: 500px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3); }
        .modal h2 { margin-top: 0; }
        .modal footer { text-align: right; margin-top: 20px; }

        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 2000; }
        .toast { padding: 10px 20px; margin-bottom: 10px; border-radius: 6px; color: white; opacity: 0; transition: opacity 0.5s, transform 0.5s; transform: translateY(20px); }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }
        
        #loading-indicator { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.8); z-index: 3000; display: none; justify-content: center; align-items: center; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: var(--accent); animation: spin 1s ease infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Pagos */
        .payments-section { display: flex; gap: 20px; margin-top: 40px; flex-wrap: wrap; }
        .payment-form, .payment-history { flex: 1; min-width: 400px; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    </style>
</head>
<body>

<div id="loading-indicator"><div class="spinner"></div></div>

<div class="container">
    <h1>Gestión de Entrega a Satélites</h1>

    <div class="controls">
        <div class="input-group">
            <input type="text" id="product-search" class="form-input" placeholder="Buscar por Serial, Referencia o Satélite...">
        </div>
        <button id="upload-delivery-csv-btn" class="btn btn-success"><i class="fas fa-truck"></i> Subir Entregas (CSV)</button>
        <input type="file" id="delivery-csv-upload-input" accept=".csv" style="display: none;">
        
        <button id="upload-payments-csv-btn" class="btn btn-primary"><i class="fas fa-dollar-sign"></i> Subir Pagos (CSV)</button>
        <input type="file" id="payments-csv-upload-input" accept=".csv" style="display: none;">
    </div>

    <div id="satellites-container">
        </div>

    <hr style="margin: 40px 0;">
    <div class="payments-section">
        <div class="payment-form">
            <h2><i class="fas fa-money-bill-wave"></i> Registrar Nuevo Pago</h2>
            <form id="payment-form">
                <div class="form-grid">
                    <div class="input-group">
                        <label for="payment-satellite">Satélite</label>
                        <select id="payment-satellite" class="form-select" required></select>
                    </div>
                    <div class="input-group">
                        <label for="payment-date">Fecha de Pago</label>
                        <input type="date" id="payment-date" class="form-input" required>
                    </div>
                    <div class="input-group" style="grid-column: 1 / -1;">
                        <label for="payment-amount">Monto</label>
                        <input type="number" id="payment-amount" class="form-input" placeholder="Ej: 500000" required>
                    </div>
                    <div class="input-group" style="grid-column: 1 / -1;">
                        <label for="payment-observation">Observación</label>
                        <textarea id="payment-observation" class="form-input" rows="2"></textarea>
                    </div>
                </div>
                <button type="submit" class="btn btn-success" style="margin-top: 15px;">Registrar Pago</button>
            </form>
        </div>
        <div class="payment-history">
            <h2><i class="fas fa-history"></i> Historial de Pagos Recientes</h2>
            <div class="table-container" style="max-height: 300px;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Satélite</th>
                            <th>Fecha</th>
                            <th>Monto</th>
                            <th>Observación</th>
                        </tr>
                    </thead>
                    <tbody id="payment-history-body">
                        </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div id="delivery-modal" class="modal">
    <div class="modal-content">
        <h2>Actualizar Estado de Entrega</h2>
        <div class="input-group">
            <label for="delivery-status">Nuevo Estado</label>
            <select id="delivery-status" class="form-select">
                <option value="Entregado">Entregado</option>
                <option value="Devuelto">Devuelto</option>
                <option value="En Ruta">En Ruta</option>
            </select>
        </div>
        <div class="input-group" style="margin-top: 15px;">
            <label for="delivery-date">Fecha de Entrega/Devolución</label>
            <input type="date" id="delivery-date" class="form-input">
        </div>
        <footer>
            <button type="button" id="cancel-delivery-btn" class="btn">Cancelar</button>
            <button type="button" id="confirm-delivery-btn" class="btn btn-primary">Confirmar</button>
        </footer>
    </div>
</div>

<div id="toast-container"></div>

<script>
// --- Global State ---
let allProducts = [];
let allSatellites = [];
let allPayments = [];
let productIdsToUpdate = [];

// --- DOM elements ---
const dom = {
    loadingIndicator: document.getElementById('loading-indicator'),
    productSearch: document.getElementById('product-search'),
    satellitesContainer: document.getElementById('satellites-container'),
    toastContainer: document.getElementById('toast-container'),
    deliveryModal: document.getElementById('delivery-modal'),
    deliveryStatus: document.getElementById('delivery-status'),
    deliveryDate: document.getElementById('delivery-date'),
    cancelDeliveryBtn: document.getElementById('cancel-delivery-btn'),
    confirmDeliveryBtn: document.getElementById('confirm-delivery-btn'),
    paymentForm: document.getElementById('payment-form'),
    paymentSatellite: document.getElementById('payment-satellite'),
    paymentDate: document.getElementById('payment-date'),
    paymentAmount: document.getElementById('payment-amount'),
    paymentObservation: document.getElementById('payment-observation'),
    paymentHistoryBody: document.getElementById('payment-history-body'),
    // CSV Upload elements
    uploadDeliveryCsvBtn: document.getElementById('upload-delivery-csv-btn'),
    deliveryCsvUploadInput: document.getElementById('delivery-csv-upload-input'),
    uploadPaymentsCsvBtn: document.getElementById('upload-payments-csv-btn'),
    paymentsCsvUploadInput: document.getElementById('payments-csv-upload-input'),
};

// --- API Helpers ---
const showLoader = () => { dom.loadingIndicator.style.display = 'flex'; };
const hideLoader = () => { dom.loadingIndicator.style.display = 'none'; };

async function apiRequest(url, method = 'GET', data = null) {
    const options = {
        method,
        headers: { 'Content-Type': 'application/json' },
    };
    if (data) options.body = JSON.stringify(data);
    
    const response = await fetch(url, options);
    if (response.status === 204) return {};
    const responseData = await response.json();
    if (!response.ok) throw new Error(responseData.message || `Error en la solicitud a ${url}.`);
    return responseData;
}

// --- UI Helpers ---
function showToast(message, type) {
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;
    dom.toastContainer.appendChild(toast);
    setTimeout(() => toast.classList.add('show'), 10);
    setTimeout(() => {
        toast.classList.remove('show');
        toast.addEventListener('transitionend', () => toast.remove());
    }, 5000);
}

const formatDate = (dateString) => dateString ? new Date(dateString).toISOString().split('T')[0] : '';
const formatCurrency = (amount) => new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP' }).format(amount);

// --- Data Loading and Rendering ---
async function loadData() {
    showLoader();
    try {
        const [productsData, satellitesData, paymentsData] = await Promise.all([
            apiRequest('/products?estado_entrega=Pendiente'),
            apiRequest('/satellites/all'),
            apiRequest('/finances/satellite-payments')
        ]);
        
        allProducts = productsData;
        allSatellites = satellitesData;
        allPayments = paymentsData.sort((a, b) => new Date(b.payment_date) - new Date(a.payment_date));

        renderSatellites();
        renderPaymentDropdowns();
        renderPaymentHistory();

    } catch (error) {
        showToast('Error al cargar datos: ' + error.message, 'error');
    } finally {
        hideLoader();
    }
}

function renderSatellites() {
    const searchTerm = dom.productSearch.value.toLowerCase();
    
    const filteredProducts = allProducts.filter(p => 
        p.serial?.toLowerCase().includes(searchTerm) ||
        p.referencia?.toLowerCase().includes(searchTerm) ||
        p.satellite?.toLowerCase().includes(searchTerm)
    );

    const groupedBySatellite = filteredProducts.reduce((acc, p) => {
        const satName = p.satellite || 'Sin Satélite Asignado';
        if (!acc[satName]) acc[satName] = [];
        acc[satName].push(p);
        return acc;
    }, {});

    dom.satellitesContainer.innerHTML = '';
    for (const satName in groupedBySatellite) {
        const products = groupedBySatellite[satName];
        const totalQuantity = products.reduce((sum, p) => sum + (p.cantidad || 0), 0);
        
        const groupEl = document.createElement('div');
        groupEl.className = 'satellite-group';
        groupEl.innerHTML = `
            <div class="satellite-header">
                <h3>${satName}</h3>
                <div class="summary">
                    <span><strong>Productos:</strong> ${products.length}</span> | 
                    <span><strong>Unidades Totales:</strong> ${totalQuantity}</span>
                </div>
                <div>
                    <button class="btn btn-primary deliver-all-btn" data-satellite="${satName}">
                        <i class="fas fa-check-double"></i> Entregar Todo
                    </button>
                </div>
            </div>
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th style="width: 30px;"><input type="checkbox" class="select-all-satellite-checkbox" data-satellite="${satName}"></th>
                            <th>ID</th>
                            <th>Serial</th>
                            <th>Referencia</th>
                            <th>Cantidad</th>
                            <th>Tipo Tela</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${products.map(p => `
                            <tr>
                                <td><input type="checkbox" class="product-checkbox" data-id="${p.id}" data-satellite="${satName}"></td>
                                <td>${p.id}</td>
                                <td>${p.serial}</td>
                                <td>${p.referencia}</td>
                                <td>${p.cantidad}</td>
                                <td>${p.tipo_tela}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
        dom.satellitesContainer.appendChild(groupEl);
    }

    if (Object.keys(groupedBySatellite).length === 0) {
        dom.satellitesContainer.innerHTML = '<p style="text-align:center;">No se encontraron productos pendientes de entrega.</p>';
    }
}

function renderPaymentDropdowns() {
    dom.paymentSatellite.innerHTML = '<option value="">Seleccione un Satélite</option>';
    allSatellites.forEach(s => {
        const option = document.createElement('option');
        option.value = s.id;
        option.textContent = s.nombre;
        dom.paymentSatellite.appendChild(option);
    });
}

function renderPaymentHistory() {
    dom.paymentHistoryBody.innerHTML = allPayments.slice(0, 10).map(p => `
        <tr>
            <td>${p.id}</td>
            <td>${p.satellite_name || 'N/A'}</td>
            <td>${formatDate(p.payment_date)}</td>
            <td>${formatCurrency(p.amount)}</td>
            <td>${p.observation || ''}</td>
        </tr>
    `).join('');
}


// --- Event Handlers & Logic ---

function openDeliveryModal(ids) {
    if (ids.length === 0) {
        showToast('Seleccione al menos un producto.', 'warning');
        return;
    }
    productIdsToUpdate = ids;
    dom.deliveryDate.value = new Date().toISOString().split('T')[0];
    dom.deliveryModal.classList.add('active');
}

async function updateDeliveryStatus(productIds, status, deliveryDate) {
    if (!deliveryDate) {
        showToast('Debe seleccionar una fecha.', 'error');
        return;
    }
    showLoader();
    try {
        await apiRequest('/products/update-delivery-status', 'PUT', {
            product_ids: productIds,
            status: status,
            delivery_date: deliveryDate
        });
        showToast(`Se actualizaron ${productIds.length} productos a "${status}".`, 'success');
        dom.deliveryModal.classList.remove('active');
        await loadData();
    } catch (error) {
        showToast('Error al actualizar: ' + error.message, 'error');
    } finally {
        hideLoader();
    }
}

async function registrarPago(e) {
    e.preventDefault();
    const payload = {
        satellite_id: dom.paymentSatellite.value,
        amount: parseFloat(dom.paymentAmount.value),
        payment_date: dom.paymentDate.value,
        observation: dom.paymentObservation.value,
    };

    if (!payload.satellite_id || !payload.amount || !payload.payment_date) {
        showToast('Complete los campos requeridos.', 'warning');
        return;
    }

    showLoader();
    try {
        await apiRequest('/finances/satellite-payments', 'POST', payload);
        showToast('Pago registrado con éxito.', 'success');
        dom.paymentForm.reset();
        await loadData();
    } catch (error) {
        showToast('Error al registrar pago: ' + error.message, 'error');
    } finally {
        hideLoader();
    }
}

// --- NEW: CSV Upload Handlers ---

async function handleDeliveryCsvUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    showLoader();
    const reader = new FileReader();
    reader.onload = async (e) => {
        let successCount = 0;
        let errorCount = 0;
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];
            const jsonRows = XLSX.utils.sheet_to_json(worksheet, { raw: false });

            if (jsonRows.length === 0) throw new Error("El archivo CSV está vacío.");

            const updatesByStatusAndDate = {};

            for (const row of jsonRows) {
                const productId = row.id;
                const status = row.estado_entrega;
                let deliveryDate = row.fecha_entrega;
                
                if (deliveryDate && typeof deliveryDate === 'number') { // Excel date serial number
                    deliveryDate = new Date(Math.round((deliveryDate - 25569) * 86400 * 1000)).toISOString().split('T')[0];
                } else if (deliveryDate) {
                    deliveryDate = new Date(deliveryDate).toISOString().split('T')[0];
                }

                if (!productId || !status || !deliveryDate) {
                    console.warn('Fila omitida por datos incompletos:', row);
                    errorCount++;
                    continue;
                }
                
                const key = `${status}|${deliveryDate}`;
                if (!updatesByStatusAndDate[key]) {
                    updatesByStatusAndDate[key] = [];
                }
                updatesByStatusAndDate[key].push(productId);
            }

            for (const key in updatesByStatusAndDate) {
                const [status, date] = key.split('|');
                const ids = updatesByStatusAndDate[key];
                try {
                    await apiRequest('/products/update-delivery-status', 'PUT', {
                        product_ids: ids,
                        status: status,
                        delivery_date: date
                    });
                    successCount += ids.length;
                } catch (apiError) {
                    console.error(`Error en lote para estado "${status}" y fecha "${date}":`, apiError);
                    errorCount += ids.length;
                }
            }
            showToast(`Proceso completado. Éxitos: ${successCount}, Errores: ${errorCount}`, successCount > 0 ? 'success' : 'warning');

        } catch (error) {
            showToast('Error al procesar el archivo de entregas: ' + error.message, 'error');
        } finally {
            hideLoader();
            dom.deliveryCsvUploadInput.value = '';
            await loadData();
        }
    };
    reader.readAsArrayBuffer(file);
}

async function handlePaymentsCsvUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    showLoader();
    const reader = new FileReader();
    reader.onload = async (e) => {
        let successCount = 0;
        let errorCount = 0;
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];
            const jsonRows = XLSX.utils.sheet_to_json(worksheet, { raw: false });

            if (jsonRows.length === 0) throw new Error("El archivo CSV está vacío.");

            for (const row of jsonRows) {
                let paymentDate = row.payment_date;
                if (paymentDate && typeof paymentDate === 'number') {
                    paymentDate = new Date(Math.round((paymentDate - 25569) * 86400 * 1000)).toISOString().split('T')[0];
                } else if (paymentDate) {
                    paymentDate = new Date(paymentDate).toISOString().split('T')[0];
                }

                const payload = {
                    satellite_id: row.satellite_id,
                    amount: parseFloat(row.amount),
                    payment_date: paymentDate,
                    observation: row.observation || 'Cargado desde CSV',
                };
                
                if (!payload.satellite_id || isNaN(payload.amount) || !payload.payment_date) {
                    console.warn('Fila de pago omitida por datos incompletos:', row);
                    errorCount++;
                    continue;
                }
                
                try {
                    await apiRequest('/finances/satellite-payments', 'POST', payload);
                    successCount++;
                } catch (apiError) {
                    console.error('Error al registrar pago desde CSV:', apiError, row);
                    errorCount++;
                }
            }
            showToast(`Carga de pagos completada. Registrados: ${successCount}, Errores: ${errorCount}`, successCount > 0 ? 'success' : 'warning');

        } catch (error) {
            showToast('Error al procesar el archivo de pagos: ' + error.message, 'error');
        } finally {
            hideLoader();
            dom.paymentsCsvUploadInput.value = '';
            await loadData();
        }
    };
    reader.readAsArrayBuffer(file);
}

// --- Initialization ---
function init() {
    document.addEventListener('DOMContentLoaded', loadData);
    dom.productSearch.addEventListener('input', renderSatellites);
    
    dom.satellitesContainer.addEventListener('click', (e) => {
        const target = e.target;
        const satellite = target.dataset.satellite;

        if (target.classList.contains('select-all-satellite-checkbox')) {
            document.querySelectorAll(`.product-checkbox[data-satellite="${satellite}"]`)
                .forEach(cb => cb.checked = target.checked);
        }
        
        if (target.classList.contains('deliver-all-btn')) {
            const ids = Array.from(document.querySelectorAll(`.product-checkbox[data-satellite="${satellite}"]`))
                .map(cb => parseInt(cb.dataset.id));
            openDeliveryModal(ids);
        }
    });

    dom.cancelDeliveryBtn.addEventListener('click', () => dom.deliveryModal.classList.remove('active'));
    dom.confirmDeliveryBtn.addEventListener('click', () => updateDeliveryStatus(productIdsToUpdate, dom.deliveryStatus.value, dom.deliveryDate.value));
    
    dom.paymentForm.addEventListener('submit', registrarPago);

    // --- NEW: CSV upload event listeners ---
    dom.uploadDeliveryCsvBtn.addEventListener('click', () => dom.deliveryCsvUploadInput.click());
    dom.deliveryCsvUploadInput.addEventListener('change', handleDeliveryCsvUpload);

    dom.uploadPaymentsCsvBtn.addEventListener('click', () => dom.paymentsCsvUploadInput.click());
    dom.paymentsCsvUploadInput.addEventListener('change', handlePaymentsCsvUpload);
}

init();
</script>

</body>
</html>
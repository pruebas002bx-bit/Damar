<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Referencias - DAMAR</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <!-- Librería para leer archivos Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-dark: #2C3E50; --secondary-light: #ECF0F1; --accent: #3498DB;
            --text-dark: #34495E; --success: #27AE60; --danger: #E74C3C;
            --border-color: #dfe4ea; --gradient-primary: linear-gradient(135deg, #667eea, #764ba2);
            --shadow: 0 10px 30px rgba(44, 62, 80, 0.1); --font-family: 'Poppins', sans-serif;
            --border-radius-lg: 12px; --border-radius-md: 8px;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: var(--font-family); background-color: var(--secondary-light); color: var(--text-dark); }
        .container { max-width: 1300px; margin: 2rem auto; padding: 0 1.5rem; }
        .card { background-color: white; border-radius: var(--border-radius-lg); padding: 2.5rem; margin-bottom: 2rem; box-shadow: var(--shadow); }
        .content-header { text-align: center; margin-bottom: 2.5rem; }
        .content-title { font-size: 2.5rem; font-weight: 700; color: var(--primary-dark); }
        .form-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; align-items: end; }
        .form-group { display: flex; flex-direction: column; }
        .form-label { font-weight: 600; margin-bottom: 0.6rem; }
        .form-input, .form-select { width: 100%; padding: 12px 16px; border: 1px solid var(--border-color); border-radius: var(--border-radius-md); font-size: 1rem; }
        .buttons-container { display: flex; flex-wrap: wrap; gap: 1rem; margin-top: 2rem; border-top: 1px solid var(--border-color); padding-top: 2rem; }
        .btn { border: none; border-radius: var(--border-radius-md); padding: 12px 24px; font-size: 0.95rem; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 0.75rem; transition: all 0.3s ease; text-transform: uppercase; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: var(--gradient-primary); color: white; }
        .btn-danger { background-color: var(--danger); color: white; }
        .btn-secondary { background-color: #6c757d; color: white; }
        .btn-warning { background-color: #f39c12; color: white; }
        .table-container { overflow-x: auto; }
        .data-table { width: 100%; border-collapse: collapse; text-align: left; }
        .data-table th, .data-table td { padding: 16px 20px; vertical-align: middle; border-bottom: 1px solid var(--border-color); }
        .data-table thead th { background-color: #f8f9fa; text-transform: uppercase; font-size: 13px; }
        .hidden { display: none; }
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 1050; }
        .toast { display: flex; align-items: center; padding: 15px 20px; border-radius: var(--border-radius-md); color: white; font-weight: 500; margin-bottom: 10px; box-shadow: var(--shadow); transform: translateX(120%); animation: slideIn 0.5s forwards; }
        .toast.success { background-color: var(--success); }
        .toast.error { background-color: var(--danger); }
        @keyframes slideIn { to { transform: translateX(0); } }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); display: none; z-index: 1000; justify-content: center; align-items: center; }
        .modal-overlay.show { display: flex; }
        .modal { background: white; border-radius: var(--border-radius-lg); padding: 2rem; max-width: 500px; width: 90%; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color); margin-bottom: 1.5rem; }
        .modal-title { font-size: 1.5rem; }
        .close-btn { background: none; border: none; font-size: 1.8rem; cursor: pointer; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 1rem; margin-top: 2rem; }
        .tab-nav { display: flex; border-bottom: 2px solid var(--border-color); margin-bottom: 2rem; }
        .tab-btn { padding: 12px 20px; font-size: 1rem; font-weight: 600; cursor: pointer; border: none; background-color: transparent; color: var(--text-dark); border-bottom: 3px solid transparent; transition: all 0.3s ease; }
        .tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; animation: fadeIn 0.4s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>
    <div id="toastContainer" class="toast-container"></div>
    
    <div id="editModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Editar Referencia</h3>
                <button class="close-btn" id="closeModal">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editItemId">
                <input type="hidden" id="editItemType">
                <input type="hidden" id="editItemCategory">
                <div class="form-group">
                    <label class="form-label" for="editCode">Referencia</label>
                    <input type="text" id="editCode" class="form-input" required>
                </div>
                <div class="form-group" style="margin-top: 1rem;">
                    <label class="form-label" for="editDescription">Código de Barras</label>
                    <input type="text" id="editDescription" class="form-input">
                </div>
                <div id="productCostsFields">
                    <div class="form-group" style="margin-top: 1rem;">
                        <label class="form-label" for="editCostoVenta">Costo de Venta</label>
                        <input type="number" id="editCostoVenta" class="form-input" placeholder="0.00" step="0.01">
                    </div>
                    <div class="form-group" style="margin-top: 1rem;">
                        <label class="form-label" for="editCostoConfeccion">Costo de Confección</label>
                        <input type="number" id="editCostoConfeccion" class="form-input" placeholder="0.00" step="0.01">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelEdit">Cancelar</button>
                <button class="btn btn-primary" id="saveEdit"><i class="fa-solid fa-save"></i> Guardar</button>
            </div>
        </div>
    </div>

    <div class="container">
        <header class="content-header">
            <h1 class="content-title">Gestión de Referencias</h1>
        </header>
        <main>
            <nav class="tab-nav">
                <button class="tab-btn active" data-tab="agregar-panel">Gestionar Referencias</button>
                <button class="tab-btn" data-tab="ver-todas-panel">Ver Todas las Referencias</button>
            </nav>

            <div id="agregar-panel" class="tab-panel active">
                <section class="card">
                     <div class="form-section">
                        <div class="form-group">
                            <label class="form-label" for="categorySelect">Tipo de Referencia</label>
                            <select id="categorySelect" class="form-select">
                                <option value="ref_products" selected>Producto</option>
                                <option value="ref_materials">Material</option>
                            </select>
                        </div>
                    </div>
                    <div id="mainForm" style="margin-top: 1.5rem;">
                        <div class="form-section">
                            <div class="form-group">
                                <label class="form-label" id="mainLabel" for="mainInput">Nueva Referencia</label>
                                <input type="text" id="mainInput" class="form-input" placeholder="EJ: VESTIDO ARIADNA LARGO" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="barcodeInput">Código de Barras (Opcional)</label>
                                <input type="text" id="barcodeInput" class="form-input" placeholder="EJ: 770123456789">
                            </div>
                        </div>
                        <div id="addCostsContainer">
                            <div class="form-section" style="margin-top: 1.5rem;">
                                <div class="form-group">
                                    <label class="form-label" for="costoVentaInput">Costo Venta (Opcional)</label>
                                    <input type="number" id="costoVentaInput" class="form-input" placeholder="0.00" step="0.01">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="costoConfeccionInput">Costo Confección (Opcional)</label>
                                    <input type="number" id="costoConfeccionInput" class="form-input" placeholder="0.00" step="0.01">
                                </div>
                            </div>
                        </div>
                    </div>
                     <div class="buttons-container">
                        <button id="addBtn" class="btn btn-primary"><i class="fa-solid fa-plus"></i> Agregar</button>
                        <button id="uploadExcelBtn" class="btn btn-secondary"><i class="fa-solid fa-file-excel"></i> Subir desde Excel</button>
                        <input type="file" id="excelFileInput" class="hidden" accept=".xlsx, .xls">
                     </div>
                </section>
                
                <section class="card" id="tableSection">
                    <h3 id="tableTitle" style="margin-bottom: 1.5rem;">Listado de Referencias de Productos</h3>
                    <input type="text" id="searchInput" class="form-input" placeholder="Buscar en la tabla..." style="margin-bottom: 1.5rem; max-width: 400px;">
                    <div class="table-container">
                        <table class="data-table">
                            <thead id="dataTableHeader"></thead>
                            <tbody id="dataTableBody"></tbody>
                        </table>
                    </div>
                     <div class="buttons-container" style="justify-content: flex-end;">
                        <button id="editBtn" class="btn btn-warning" disabled><i class="fa-solid fa-edit"></i> Editar Seleccionado</button>
                        <button id="deleteBtn" class="btn btn-danger" disabled><i class="fa-solid fa-trash"></i> Eliminar Seleccionados</button>
                    </div>
                </section>
            </div>

            <div id="ver-todas-panel" class="tab-panel">
                <section class="card">
                    <h3 style="margin-bottom: 1.5rem;">Historial de Todas las Referencias</h3>
                     <input type="text" id="allReferencesSearch" class="form-input" placeholder="Buscar por referencia, código de barras, categoría..." style="margin-bottom: 1.5rem; max-width: 400px;">
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Categoría</th>
                                    <th>Referencia</th>
                                    <th>Código de Barras</th>
                                    <th>Costo Venta</th>
                                    <th>Costo Confección</th>
                                </tr>
                            </thead>
                            <tbody id="allReferencesTableBody"></tbody>
                        </table>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const API_URL = 'https://damar-app.onrender.com';
        let productRefs = [];
        let materialRefs = [];
        let allReferencesData = [];

        const dom = {
            tabs: document.querySelectorAll('.tab-btn'),
            categorySelect: document.getElementById('categorySelect'),
            mainInput: document.getElementById('mainInput'),
            barcodeInput: document.getElementById('barcodeInput'),
            costoVentaInput: document.getElementById('costoVentaInput'),
            costoConfeccionInput: document.getElementById('costoConfeccionInput'),
            tableTitle: document.getElementById('tableTitle'),
            dataTableHeader: document.getElementById('dataTableHeader'),
            dataTableBody: document.getElementById('dataTableBody'),
            searchInput: document.getElementById('searchInput'),
            addBtn: document.getElementById('addBtn'),
            editBtn: document.getElementById('editBtn'),
            deleteBtn: document.getElementById('deleteBtn'),
            uploadExcelBtn: document.getElementById('uploadExcelBtn'),
            excelFileInput: document.getElementById('excelFileInput'),
            allReferencesTableBody: document.getElementById('allReferencesTableBody'),
            allReferencesSearch: document.getElementById('allReferencesSearch'),
            editModal: document.getElementById('editModal'),
            closeModal: document.getElementById('closeModal'),
            editItemId: document.getElementById('editItemId'),
            editItemType: document.getElementById('editItemType'),
            editItemCategory: document.getElementById('editItemCategory'),
            editCode: document.getElementById('editCode'),
            editDescription: document.getElementById('editDescription'),
            editCostoVenta: document.getElementById('editCostoVenta'),
            editCostoConfeccion: document.getElementById('editCostoConfeccion'),
            cancelEdit: document.getElementById('cancelEdit'),
            saveEdit: document.getElementById('saveEdit'),
        };

        const showToast = (message, type = 'success') => {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 5000);
        };
        
        async function apiRequest(endpoint, method = 'GET', data = null) {
            try {
                const options = { method, headers: { 'Content-Type': 'application/json' }, mode: 'cors' };
                if (data) options.body = JSON.stringify(data);
                const response = await fetch(`${API_URL}${endpoint}`, options);
                
                if (response.status === 204) return null;
                
                const textResponse = await response.text();
                let responseData;
                try {
                    responseData = JSON.parse(textResponse);
                } catch (e) {
                    throw new Error(`Respuesta inválida del servidor. Status: ${response.status}`);
                }

                if (!response.ok) {
                    throw new Error(responseData.message || `Error del servidor: ${response.status}`);
                }
                return responseData;
            } catch (error) {
                console.error("API Request Error:", error);
                throw error;
            }
        }
        
        function formatCostCell(value) {
            const numValue = parseFloat(value);
            if (isNaN(numValue) || !numValue) {
                return `<span style="color: #95a5a6;">N/A</span>`;
            }
            return new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 }).format(numValue);
        }
        
        function updateTableDisplay() {
            const category = dom.categorySelect.value;
            const isProducts = category === 'ref_products';
            dom.tableTitle.textContent = `Listado de Referencias de ${isProducts ? 'Productos' : 'Materiales'}`;
            renderTable();
        }

        dom.tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const target = tab.dataset.tab;
                dom.tabs.forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(target).classList.add('active');
                if (target === 'ver-todas-panel') {
                    loadAllData();
                } else {
                    updateTableDisplay();
                }
            });
        });

        function updateActionButtons() {
            const checkedBoxes = dom.dataTableBody.querySelectorAll('input[type="checkbox"]:checked');
            dom.editBtn.disabled = checkedBoxes.length !== 1;
            dom.deleteBtn.disabled = checkedBoxes.length === 0;
        }

        function renderTable() {
            const category = dom.categorySelect.value;
            const data = category === 'ref_products' ? productRefs : materialRefs;
            const filter = dom.searchInput.value.toLowerCase();
            
            dom.dataTableHeader.innerHTML = `
                <tr>
                    <th><input type="checkbox" id="selectAllCheckbox"></th>
                    <th>Referencia</th>
                    <th>Código de Barras</th>
                    <th>Costo Venta</th>
                    <th>Costo Confección</th>
                </tr>
            `;

            const filteredData = data.filter(item => 
                (item.code || '').toLowerCase().includes(filter) || 
                (item.description || '').toLowerCase().includes(filter)
            );

            dom.dataTableBody.innerHTML = '';
            filteredData.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><input type="checkbox" data-id="${item.id}"></td>
                    <td>${item.code || ''}</td>
                    <td>${item.description || 'N/A'}</td>
                    <td>${formatCostCell(item.costo_venta)}</td>
                    <td>${formatCostCell(item.costo_confeccion)}</td>
                `;
                dom.dataTableBody.appendChild(tr);
            });
            
            document.getElementById('selectAllCheckbox').addEventListener('change', e => {
                 dom.dataTableBody.querySelectorAll('input[type="checkbox"]').forEach(c => c.checked = e.target.checked);
                 updateActionButtons();
            });
            updateActionButtons();
        }

        async function loadInitialData() {
            try {
                [productRefs, materialRefs] = await Promise.all([
                    apiRequest('/dynamic-codes/references/ref_products'),
                    apiRequest('/dynamic-codes/references/ref_materials'),
                ]);
                updateTableDisplay();
                await loadAllData(); 
            } catch (error) {
                showToast('Error al cargar datos iniciales.', 'error');
                dom.dataTableBody.innerHTML = `<tr><td colspan="5" style="text-align:center;">Error al cargar datos.</td></tr>`;
            }
        }
        
        async function loadAllData() {
            try {
                allReferencesData = await apiRequest('/dynamic-codes/all-references');
                renderAllReferencesTable();
            } catch (error) {
                showToast('Error al cargar el historial de referencias.', 'error');
                dom.allReferencesTableBody.innerHTML = `<tr><td colspan="5" style="text-align:center;">Error al cargar datos.</td></tr>`;
            }
        }

        function renderAllReferencesTable() {
            const searchFilter = dom.allReferencesSearch.value.toLowerCase();
            
            const filteredData = allReferencesData.filter(item => {
                const categoryText = item.category === 'ref_products' ? 'producto' : 'material';
                return !searchFilter || 
                       (item.code || '').toLowerCase().includes(searchFilter) || 
                       (item.description || '').toLowerCase().includes(searchFilter) ||
                       categoryText.includes(searchFilter);
            });
            
            dom.allReferencesTableBody.innerHTML = '';
            filteredData.forEach(item => {
                const tr = document.createElement('tr');
                const categoryCell = item.category === 'ref_products' 
                    ? `<span style="background-color: #3498db; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8em;">Producto</span>`
                    : `<span style="background-color: #f39c12; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8em;">Material</span>`;
                tr.innerHTML = `
                    <td>${categoryCell}</td>
                    <td>${item.code || ''}</td>
                    <td>${item.description || 'N/A'}</td>
                    <td>${formatCostCell(item.costo_venta)}</td>
                    <td>${formatCostCell(item.costo_confeccion)}</td>
                `;
                dom.allReferencesTableBody.appendChild(tr);
            });
        }
        
        function openEditModal() {
            const checkedBox = dom.dataTableBody.querySelector('input[type="checkbox"]:checked');
            if (!checkedBox) return;
            
            const category = dom.categorySelect.value;
            const data = category === 'ref_products' ? productRefs : materialRefs;
            const itemToEdit = data.find(item => item.id == checkedBox.dataset.id);
            
            if (!itemToEdit) return;

            dom.editItemId.value = itemToEdit.id;
            dom.editItemType.value = 'references';
            dom.editItemCategory.value = category;
            dom.editCode.value = itemToEdit.code;
            dom.editDescription.value = itemToEdit.description || '';
            dom.editCostoVenta.value = itemToEdit.costo_venta || '';
            dom.editCostoConfeccion.value = itemToEdit.costo_confeccion || '';
            dom.editModal.classList.add('show');
        }

        function closeEditModal() {
            dom.editModal.classList.remove('show');
        }

        async function saveEditedItem() {
            const itemId = dom.editItemId.value;
            const type = dom.editItemType.value;
            const category = dom.editItemCategory.value;

            if (!itemId || !type || !category) return;
            
            const newCode = dom.editCode.value.trim();
            if (!newCode) return showToast('La Referencia es obligatoria.', 'error');
            
            const payload = {
                code: newCode,
                description: dom.editDescription.value.trim(),
                costo_venta: dom.editCostoVenta.value || null,
                costo_confeccion: dom.editCostoConfeccion.value || null
            };

            try {
                const endpoint = `/dynamic-codes/${type}/${category}/${itemId}`;
                await apiRequest(endpoint, 'PUT', payload);
                showToast('Registro actualizado.', 'success');
                closeEditModal();
                await loadInitialData();
            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        async function deleteSelectedItems() {
            const checkedBoxes = Array.from(dom.dataTableBody.querySelectorAll('input[type="checkbox"]:checked'));
            if (checkedBoxes.length === 0) return showToast('Seleccione registros para eliminar.', 'error');
            
            if (!confirm(`¿Seguro que desea eliminar ${checkedBoxes.length} registro(s)?`)) return;

            const category = dom.categorySelect.value;
            const type = 'references';
            const idsToDelete = checkedBoxes.map(cb => parseInt(cb.dataset.id));

            try {
                const endpoint = `/dynamic-codes/${type}/${category}`;
                await apiRequest(endpoint, 'DELETE', { ids: idsToDelete });
                showToast('Registros eliminados.', 'success');
                await loadInitialData();
            } catch (error) {
                showToast(error.message, 'error');
            }
        }
        
        dom.addBtn.addEventListener('click', async () => {
            const code = dom.mainInput.value.trim();
            if (!code) return showToast('El campo Nueva Referencia es obligatorio.', 'error');
            
            const category = dom.categorySelect.value;
            const endpoint = `/dynamic-codes/references/${category}`;
            
            const payload = {
                code: code,
                description: dom.barcodeInput.value.trim(),
                costo_venta: dom.costoVentaInput.value || null,
                costo_confeccion: dom.costoConfeccionInput.value || null
            };

            try {
                await apiRequest(endpoint, 'POST', payload);
                showToast('Registro agregado.', 'success');
                dom.mainInput.value = '';
                dom.barcodeInput.value = '';
                dom.costoVentaInput.value = '';
                dom.costoConfeccionInput.value = '';
                await loadInitialData();
            } catch (error) {
                showToast(error.message, 'error');
            }
        });
        
        const handleFileUpload = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, {
                        raw: false // Importante para obtener fechas y números como texto
                    });
                    
                    if (jsonData.length === 0) {
                        return showToast('El archivo Excel está vacío o no tiene datos.', 'error');
                    }

                    const headers = Object.keys(jsonData[0]);
                    const columnMap = {
                        code: headers.find(h => h.trim().toLowerCase().includes('referencia')),
                        description: headers.find(h => h.trim().toLowerCase().includes('barras')),
                        costo_venta: headers.find(h => h.trim().toLowerCase().includes('venta')),
                        costo_confeccion: headers.find(h => h.trim().toLowerCase().includes('confección') || h.trim().toLowerCase().includes('confeccion')),
                    };

                    if (!columnMap.code) {
                        return showToast('No se encontró una columna que contenga "Referencia" en el archivo Excel. Es obligatoria.', 'error');
                    }

                    const validData = jsonData.map(row => {
                        const costoVentaRaw = row[columnMap.costo_venta];
                        const costoConfeccionRaw = row[columnMap.costo_confeccion];
                        
                        const costoVenta = costoVentaRaw ? parseFloat(String(costoVentaRaw).replace(/[^0-9.,-]/g, '').replace(',', '.')) : null;
                        const costoConfeccion = costoConfeccionRaw ? parseFloat(String(costoConfeccionRaw).replace(/[^0-9.,-]/g, '').replace(',', '.')) : null;

                        return {
                            code: row[columnMap.code] ? String(row[columnMap.code]).trim() : null,
                            description: row[columnMap.description] ? String(row[columnMap.description]).trim() : null,
                            costo_venta: !isNaN(costoVenta) ? costoVenta : null,
                            costo_confeccion: !isNaN(costoConfeccion) ? costoConfeccion : null,
                        };
                    }).filter(row => row.code);


                    if (validData.length === 0) {
                        return showToast('No se encontraron filas con una "Referencia" válida para subir.', 'error');
                    }

                    showToast(`Iniciando subida de ${validData.length} registros...`, 'success');
                    
                    const category = dom.categorySelect.value;
                    const endpoint = `/dynamic-codes/references/${category}`;
                    
                    let successCount = 0;
                    let errorCount = 0;

                    for (const row of validData) {
                        try {
                            await apiRequest(endpoint, 'POST', row);
                            successCount++;
                        } catch (error) {
                            errorCount++;
                            console.error(`Error subiendo la fila: ${JSON.stringify(row)}`, error);
                        }
                    }
                    
                    let finalMessage = `${successCount} de ${validData.length} registros subidos correctamente.`;
                    if (errorCount > 0) {
                        finalMessage += ` ${errorCount} registros fallaron. Revise la consola para más detalles.`;
                    }
                    showToast(finalMessage, errorCount > 0 ? 'error' : 'success');
                    
                    await loadInitialData();

                } catch (error) {
                    showToast('Error crítico al procesar el archivo Excel.', 'error');
                    console.error("Error processing Excel file:", error);
                } finally {
                    dom.excelFileInput.value = '';
                }
            };
            reader.readAsArrayBuffer(file);
        };

        // --- Event Listeners ---
        dom.categorySelect.addEventListener('change', updateTableDisplay);
        dom.editBtn.addEventListener('click', openEditModal);
        dom.deleteBtn.addEventListener('click', deleteSelectedItems);
        dom.searchInput.addEventListener('input', renderTable);
        dom.allReferencesSearch.addEventListener('input', renderAllReferencesTable);
        dom.dataTableBody.addEventListener('change', (e) => { if(e.target.type === 'checkbox') updateActionButtons(); });
        
        dom.closeModal.addEventListener('click', closeEditModal);
        dom.cancelEdit.addEventListener('click', closeEditModal);
        dom.saveEdit.addEventListener('click', saveEditedItem);
        dom.editModal.addEventListener('click', (e) => { if (e.target === dom.editModal) closeEditModal(); });
        
        dom.uploadExcelBtn.addEventListener('click', () => dom.excelFileInput.click());
        dom.excelFileInput.addEventListener('change', handleFileUpload);
        
        // --- Carga Inicial ---
        loadInitialData();
    });
    </script>
</body>
</html>


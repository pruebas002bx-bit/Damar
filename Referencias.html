<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Referencias - DAMAR</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        :root {
            --primary-dark: #2C3E50; --secondary-light: #ECF0F1; --accent: #3498DB;
            --text-dark: #34495E; --success: #27AE60; --danger: #E74C3C;
            --border-color: #dfe4ea; --gradient-primary: linear-gradient(135deg, #667eea, #764ba2);
            --shadow: 0 10px 30px rgba(44, 62, 80, 0.1); --font-family: 'Poppins', sans-serif;
            --border-radius-lg: 12px; --border-radius-md: 8px;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: var(--font-family); background-color: var(--secondary-light); color: var(--text-dark); }
        .container { max-width: 1400px; margin: 2rem auto; padding: 0 1.5rem; }
        .card { background: white; border-radius: var(--border-radius-lg); padding: 2.5rem; box-shadow: var(--shadow); margin-bottom: 2rem; }
        .header { text-align: center; margin-bottom: 2.5rem; }
        .title { font-size: 2.5rem; font-weight: 700; color: var(--primary-dark); }
        .subtitle { font-size: 1.1rem; color: var(--text-dark); max-width: 600px; margin: 0.5rem auto 0; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1.5rem 2rem; }
        .form-group { display: flex; flex-direction: column; }
        .form-label { font-weight: 600; margin-bottom: 0.6rem; color: var(--primary-dark); font-size: 0.9rem; }
        .form-input, .form-select, .form-textarea {
            width: 100%; padding: 12px 16px; border: 1px solid var(--border-color);
            border-radius: var(--border-radius-md); font-size: 1rem; transition: all 0.3s ease;
        }
        .form-textarea { resize: vertical; min-height: 80px; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.15); }
        .materials-list { list-style: none; max-height: 200px; overflow-y: auto; border: 1px solid var(--border-color); padding: 1rem; border-radius: var(--border-radius-md); }
        .materials-list li { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; }
        .buttons-container { display: flex; flex-wrap: wrap; gap: 1rem; margin-top: 2rem; border-top: 1px solid var(--border-color); padding-top: 2rem; }
        .btn { border: none; border-radius: var(--border-radius-md); padding: 12px 24px; font-size: 0.95rem; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 0.75rem; transition: all 0.3s ease; text-transform: uppercase; }
        .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 15px 35px rgba(44, 62, 80, 0.15); }
        .btn-primary { background: var(--gradient-primary); color: white; }
        .btn-danger { background-color: var(--danger); color: white; }
        .btn-secondary { background-color: var(--secondary-light); color: var(--text-dark); border: 1px solid var(--border-color); }
        .table-container { overflow-x: auto; }
        .data-table { width: 100%; border-collapse: collapse; text-align: left; }
        .data-table th, .data-table td { padding: 14px 18px; vertical-align: middle; border-bottom: 1px solid var(--border-color); }
        .data-table thead th { background-color: #f8f9fa; color: var(--primary-dark); font-size: 13px; font-weight: 600; text-transform: uppercase; }
        .data-table tbody tr:hover { background-color: #f5f5f5; cursor: pointer; }
        .data-table tr.selected { background-color: rgba(52, 152, 219, 0.1) !important; box-shadow: inset 4px 0 0 0 var(--accent); }
        .loading-spinner { width: 50px; height: 50px; border: 4px solid var(--border-color); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin: 2rem auto; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 1050; }
        .toast { display: flex; align-items: center; padding: 15px 20px; border-radius: var(--border-radius-md); color: white; font-weight: 500; margin-bottom: 10px; box-shadow: var(--shadow); transform: translateX(120%); animation: slideIn 0.5s forwards; }
        .toast.success { background-color: var(--success); }
        .toast.error { background-color: var(--danger); }
        @keyframes slideIn { to { transform: translateX(0); } }
    </style>
</head>
<body>
    <div id="toastContainer" class="toast-container"></div>
    <div class="container">
        <header class="header">
            <h1 class="title">Gestión de Referencias de Productos</h1>
            <p class="subtitle">Cree, modifique y consulte las referencias de los productos y sus costos asociados.</p>
        </header>

        <main>
            <section class="card">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="nameInput" class="form-label">Nombre de Referencia</label>
                        <input type="text" id="nameInput" class="form-input" placeholder="Ej: Blusa Campesina">
                    </div>
                    <div class="form-group">
                        <label for="categorySelect" class="form-label">Categoría</label>
                        <select id="categorySelect" class="form-select">
                            <option value="Blusa">Blusa</option>
                            <option value="Vestido">Vestido</option>
                            <option value="Pantalon">Pantalón</option>
                            <option value="Falda">Falda</option>
                             <option value="Short">Short</option>
                              <option value="Conjunto">Conjunto</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="descriptionTextarea" class="form-label">Descripción</label>
                        <textarea id="descriptionTextarea" class="form-textarea" placeholder="Breve descripción del producto..."></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Materiales</label>
                        <ul id="materialsList" class="materials-list">
                           </ul>
                    </div>
                </div>
                 <div class="buttons-container">
                    <button id="addBtn" class="btn btn-primary"><i class="fa-solid fa-plus"></i> Agregar Referencia</button>
                    <button id="updateBtn" class="btn btn-primary" style="display:none;"><i class="fa-solid fa-save"></i> Guardar Cambios</button>
                    <button id="deleteBtn" class="btn btn-danger"><i class="fa-solid fa-trash"></i> Eliminar</button>
                    <button id="clearBtn" class="btn btn-secondary"><i class="fa-solid fa-eraser"></i> Limpiar</button>
                </div>
            </section>

            <section class="card">
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Categoría</th>
                                <th>Costo Total</th>
                            </tr>
                        </thead>
                        <tbody id="referencesTableBody"></tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const API_URL = 'https://damar-app.onrender.com';
        let selectedReferenceId = null;

        const dom = {
            name: document.getElementById('nameInput'),
            category: document.getElementById('categorySelect'),
            description: document.getElementById('descriptionTextarea'),
            materialsList: document.getElementById('materialsList'),
            tableBody: document.getElementById('referencesTableBody'),
            addBtn: document.getElementById('addBtn'),
            updateBtn: document.getElementById('updateBtn'),
            deleteBtn: document.getElementById('deleteBtn'),
            clearBtn: document.getElementById('clearBtn'),
        };

        const formatCurrency = (value) => (parseFloat(value) || 0).toLocaleString('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 });

        const showToast = (message, type = 'success') => {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<i class="fa-solid fa-check-circle" style="margin-right: 10px;"></i> ${message}`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        };

        async function apiRequest(endpoint, method = 'GET', data = null) {
            [dom.addBtn, dom.updateBtn, dom.deleteBtn, dom.clearBtn].forEach(b => b.disabled = true);
            try {
                const options = {
                    method,
                    headers: { 'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true' },
                    mode: 'cors'
                };
                if (data) options.body = JSON.stringify(data);
                const response = await fetch(`${API_URL}${endpoint}`, options);
                const responseData = await response.json();
                if (!response.ok) throw new Error(responseData.message || 'Error en la operación');
                return responseData;
            } catch (error) {
                showToast(error.message, 'error');
                throw error;
            } finally {
                [dom.addBtn, dom.updateBtn, dom.deleteBtn, dom.clearBtn].forEach(b => b.disabled = false);
            }
        }

        const renderReferencesTable = (references) => {
            dom.tableBody.innerHTML = '';
            references.forEach(ref => {
                const tr = document.createElement('tr');
                tr.dataset.id = ref.id;
                tr.innerHTML = `
                    <td>${ref.nombre}</td>
                    <td>${ref.categoria}</td>
                    <td>${formatCurrency(ref.costo_total)}</td>
                `;
                tr.addEventListener('click', () => selectReference(ref.id, tr));
                dom.tableBody.appendChild(tr);
            });
        };

        const loadReferences = async () => {
            try {
                // CORRECCIÓN: La API devuelve { "references": [...] }, no una lista directa.
                const response = await apiRequest('/references');
                const references = response.references || response;
                renderReferencesTable(references);
            } catch (error) {
                console.error('Error cargando referencias:', error);
            }
        };

        const loadMaterials = async () => {
            try {
                const response = await apiRequest('/materials');
                const materials = response.materials || response;
                dom.materialsList.innerHTML = '';
                materials.forEach(mat => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <label for="mat-${mat.id}">${mat.nombre} (${formatCurrency(mat.precio)})</label>
                        <input type="checkbox" id="mat-${mat.id}" value="${mat.id}" data-price="${mat.precio}">
                    `;
                    dom.materialsList.appendChild(li);
                });
            } catch (error) {
                dom.materialsList.innerHTML = '<li>Error al cargar materiales.</li>';
            }
        };

        const clearForm = () => {
            selectedReferenceId = null;
            dom.name.value = '';
            dom.category.value = 'Blusa';
            dom.description.value = '';
            dom.materialsList.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            dom.addBtn.style.display = 'inline-flex';
            dom.updateBtn.style.display = 'none';
            document.querySelectorAll('.data-table tr.selected').forEach(row => row.classList.remove('selected'));
        };

        const selectReference = async (id, rowElement) => {
            try {
                const ref = await apiRequest(`/references/${id}`);
                selectedReferenceId = ref.id;
                dom.name.value = ref.nombre;
                dom.category.value = ref.categoria;
                dom.description.value = ref.descripcion;

                dom.materialsList.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                    cb.checked = ref.materials.some(mat => String(mat.id) === cb.value);
                });

                dom.addBtn.style.display = 'none';
                dom.updateBtn.style.display = 'inline-flex';
                document.querySelectorAll('.data-table tr.selected').forEach(row => row.classList.remove('selected'));
                rowElement.classList.add('selected');
            } catch (error) {
                showToast('No se pudo cargar el detalle de la referencia.', 'error');
            }
        };

        const getFormData = () => {
            const selectedMaterials = Array.from(dom.materialsList.querySelectorAll('input:checked'))
                .map(cb => ({
                    id: parseInt(cb.value),
                    // CORRECCIÓN: El nombre de la propiedad es 'nombre', no 'name'.
                    nombre: cb.parentElement.querySelector('label').textContent.split(' (')[0],
                    precio: parseFloat(cb.dataset.price)
                }));
            
            const cost = selectedMaterials.reduce((sum, mat) => sum + mat.precio, 0);

            return {
                nombre: dom.name.value.trim(),
                categoria: dom.category.value,
                descripcion: dom.description.value.trim(),
                costo_total: cost,
                material_ids: selectedMaterials.map(m => m.id)
            };
        };

        dom.addBtn.addEventListener('click', async () => {
            const data = getFormData();
            if (!data.nombre) return showToast('El nombre de la referencia es obligatorio.', 'error');
            try {
                await apiRequest('/references', 'POST', data);
                showToast('Referencia agregada con éxito.');
                clearForm();
                loadReferences();
            } catch(error) {}
        });

        dom.updateBtn.addEventListener('click', async () => {
            if (!selectedReferenceId) return;
            const data = getFormData();
            if (!data.nombre) return showToast('El nombre de la referencia es obligatorio.', 'error');
            try {
                await apiRequest(`/references/${selectedReferenceId}`, 'PUT', data);
                showToast('Referencia actualizada con éxito.');
                clearForm();
                loadReferences();
            } catch(error) {}
        });

        dom.deleteBtn.addEventListener('click', async () => {
            if (!selectedReferenceId) return showToast('Seleccione una referencia para eliminar.', 'error');
            if (confirm(`¿Seguro que desea eliminar la referencia "${dom.name.value}"?`)) {
                try {
                    await apiRequest(`/references/${selectedReferenceId}`, 'DELETE');
                    showToast('Referencia eliminada con éxito.');
                    clearForm();
                    loadReferences();
                } catch(error) {}
            }
        });

        dom.clearBtn.addEventListener('click', clearForm);

        loadMaterials();
        loadReferences();
    });
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Bancos - DAMAR</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root {
            --primary-dark: #2C3E50; --secondary-light: #ECF0F1; --accent: #3498DB;
            --text-dark: #34495E; --text-light: white; --hover-accent: #2980B9;
            --success: #27AE60; --warning: #F39C12; --danger: #E74C3C;
            --border-color: #dfe4ea; --gradient-primary: linear-gradient(135deg, #3498DB 0%, #2C3E50 100%);
            --shadow: 0 10px 30px rgba(44, 62, 80, 0.1); --shadow-hover: 0 15px 35px rgba(44, 62, 80, 0.15);
            --font-family: 'Poppins', sans-serif; --border-radius-lg: 12px; --border-radius-md: 8px;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; }
        body {
            font-family: var(--font-family); background-color: var(--secondary-light); color: var(--text-dark);
            line-height: 1.6; animation: fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .container { max-width: 1400px; margin: 2rem auto; padding: 0 1.5rem; }
        .card {
            background-color: white; border-radius: var(--border-radius-lg); padding: 2.5rem;
            margin-bottom: 2rem; box-shadow: var(--shadow); border: 1px solid var(--border-color);
        }
        .content-header { text-align: center; margin-bottom: 2.5rem; }
        .content-title { font-size: 2.5rem; font-weight: 700; color: var(--primary-dark); margin-bottom: 0.5rem; }
        .content-subtitle { font-size: 1.1rem; color: var(--text-dark); max-width: 700px; margin: 0 auto; }
        .form-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.5rem 2rem; align-items: end;
        }
        .form-group { display: flex; flex-direction: column; }
        .form-label { font-weight: 600; margin-bottom: 0.6rem; color: var(--primary-dark); font-size: 0.9rem; }
        .form-input, .form-select {
            width: 100%; padding: 12px 16px; border: 1px solid var(--border-color);
            border-radius: var(--border-radius-md); background-color: #fdfdfe; color: var(--text-dark);
            font-size: 1rem; font-family: var(--font-family); transition: all 0.3s ease;
        }
        .form-input:focus, .form-select:focus {
            outline: none; border-color: var(--accent); background-color: white;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.15);
        }
        .form-input:disabled { background-color: #f1f2f6; cursor: not-allowed; }
        .stats-bar {
            grid-column: 1 / -1; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem; background-color: var(--primary-dark); color: var(--text-light);
            padding: 1rem; border-radius: var(--border-radius-md); margin-top: 1rem;
        }
        .stat-item { text-align: center; }
        .stat-item .stat-title { font-size: 0.8rem; opacity: 0.8; text-transform: uppercase; }
        .stat-item .stat-value { font-size: 1.4rem; font-weight: 700; }
        .buttons-container { display: flex; flex-wrap: wrap; gap: 1rem; margin-top: 2rem; border-top: 1px solid var(--border-color); padding-top: 2rem; justify-content: center;}
        .btn {
            border: none; border-radius: var(--border-radius-md); padding: 12px 24px; font-size: 0.95rem;
            font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; justify-content: center;
            gap: 0.75rem; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: var(--shadow-hover); }
        .btn:disabled { background-color: #bdc3c7; cursor: not-allowed; transform: none; box-shadow: none; opacity: 0.6; }
        .btn-primary { background: var(--gradient-primary); color: white; }
        .btn-success { background-color: var(--success); color: white; }
        .btn-danger { background-color: var(--danger); color: white; }
        .btn-secondary { background-color: #bdc3c7; color: var(--text-dark); }
        .filter-controls { display: flex; gap: 1rem; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; }
        .search-wrapper { position: relative; flex-grow: 1; }
        .search-icon { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: #909db1; }
        .search-input { width: 100%; padding-left: 3rem; }
        .filter-group { display: flex; align-items: center; gap: 0.5rem; }
        .filter-group label { font-weight: 500; font-size: 0.9rem; }
        .table-container { overflow-x: auto; }
        .data-table { width: 100%; border-collapse: collapse; text-align: left; }
        .data-table th, .data-table td { padding: 14px 18px; vertical-align: middle; border-bottom: 1px solid var(--border-color); white-space: nowrap; }
        .data-table thead th { background-color: #f8f9fa; color: var(--primary-dark); font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .data-table tbody tr { transition: background-color 0.2s ease; }
        .data-table tbody tr:hover { background-color: #f5f5f5; cursor: pointer; }
        .data-table tr.selected { background-color: rgba(52, 152, 219, 0.1) !important; box-shadow: inset 4px 0 0 0 var(--accent); }
        .data-table .checkbox-cell { text-align: center; }
        .feedback-state { text-align: center; padding: 4rem 1rem; font-size: 1.1rem; color: #6c757d; }
        .feedback-state i { font-size: 2.5rem; display: block; margin-bottom: 1rem; color: var(--accent); }
        .loading-spinner { width: 50px; height: 50px; border: 4px solid var(--border-color); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 1050; }
        .toast { display: flex; align-items: center; padding: 15px 20px; border-radius: var(--border-radius-md); color: white; font-weight: 500; margin-bottom: 10px; box-shadow: var(--shadow); transform: translateX(120%); animation: slideIn 0.5s forwards; }
        .toast.success { background-color: var(--success); }
        .toast.error { background-color: var(--danger); }
        .toast i { margin-right: 10px; font-size: 1.2rem; }
        @keyframes slideIn { to { transform: translateX(0); } }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s ease; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-content { background: white; padding: 2rem; border-radius: var(--border-radius-lg); width: 90%; max-width: 450px; text-align: center; transform: scale(0.9); transition: all 0.3s ease; }
        .modal-overlay.active .modal-content { transform: scale(1); }
        .modal-content h3 { margin-bottom: 1rem; color: var(--primary-dark); }
        .modal-content p { margin-bottom: 2rem; color: var(--text-dark); }
        .modal-buttons { display: flex; justify-content: center; gap: 1rem; }
        @media (max-width: 992px) { .stats-bar { grid-template-columns: 1fr 1fr; } }
        @media (max-width: 768px) {
            .container { margin: 1rem auto; padding: 0 1rem; }
            .card { padding: 1.5rem; }
            .content-title { font-size: 2rem; }
            .buttons-container, .filter-controls { flex-direction: column; align-items: stretch; }
            .btn, .form-input, .form-select { width: 100%; }
        }
    </style>
</head>
<body>

    <div id="toastContainer" class="toast-container"></div>
    <div id="confirmModal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modalTitle">Confirmar Acción</h3>
            <p id="modalMessage">¿Estás seguro?</p>
            <div class="modal-buttons">
                <button id="modalCancelBtn" class="btn btn-secondary">Cancelar</button>
                <button id="modalConfirmBtn" class="btn btn-danger">Confirmar</button>
            </div>
        </div>
    </div>

    <div class="container">
        <header class="content-header">
            <h1 class="content-title">Gestión de Movimientos Bancarios</h1>
            <p class="content-subtitle">Registre y administre todas las transacciones bancarias de su negocio en un solo lugar.</p>
        </header>
        
        <main>
            <section class="card">
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label" for="fechaInput">Fecha</label>
                        <input type="date" id="fechaInput" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="bancoSelect">Banco</label>
                        <select id="bancoSelect" class="form-select"></select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="puntoVentaSelect">Punto de Venta</label>
                        <select id="puntoVentaSelect" class="form-select"></select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="aprobacionInput">N° Aprobación</label>
                        <input type="text" id="aprobacionInput" class="form-input" placeholder="Número único">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="valorInput">Valor (COP)</label>
                        <input type="text" id="valorInput" class="form-input" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="cuentaInput">N° Cuenta</label>
                        <input type="text" id="cuentaInput" class="form-input" placeholder="Número de cuenta">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="tipoSelect">Tipo Transacción</label>
                        <select id="tipoSelect" class="form-select"></select>
                    </div>
                    <div class="form-group" style="grid-column: span 2;">
                        <label class="form-label" for="descripcionInput">Descripción</label>
                        <input type="text" id="descripcionInput" class="form-input" placeholder="Detalles de la transacción">
                    </div>
                    <div class="stats-bar">
                        <div class="stat-item"><div class="stat-title">Total Transacciones</div><div class="stat-value" id="statTotalTransacciones">0</div></div>
                        <div class="stat-item"><div class="stat-title">Valor Total</div><div class="stat-value" id="statTotalValor">$0</div></div>
                        <div class="stat-item"><div class="stat-title">Este Mes</div><div class="stat-value" id="statMesActual">$0</div></div>
                        <div class="stat-item"><div class="stat-title">Promedio Diario (30d)</div><div class="stat-value" id="statPromedioDiario">$0</div></div>
                    </div>
                </div>
        
                <div class="buttons-container">
                    <button id="addBtn" class="btn btn-primary"><i class="fa-solid fa-plus"></i> Registrar</button>
                    <button id="editBtn" class="btn btn-success"><i class="fa-solid fa-pen-to-square"></i> Guardar Cambios</button>
                    <button id="deleteBtn" class="btn btn-danger"><i class="fa-solid fa-trash-can"></i> Eliminar</button>
                    <button id="clearBtn" class="btn btn-secondary"><i class="fa-solid fa-eraser"></i> Limpiar</button>
                    <button id="exportBtn" class="btn btn-secondary"><i class="fa-solid fa-file-excel"></i> Exportar</button>
                </div>
            </section>
            
            <section class="card">
                <div class="filter-controls">
                    <div class="search-wrapper">
                        <i class="fa-solid fa-magnifying-glass search-icon"></i>
                        <input type="text" id="searchInput" class="form-input search-input" placeholder="Buscar por Banco, Punto de Venta, N° Aprobación...">
                    </div>
                    <div class="filter-group">
                        <label for="filterBancoSelect">Banco:</label>
                        <select id="filterBancoSelect" class="form-select"></select>
                    </div>
                    <div class="filter-group">
                        <label for="filterTipoSelect">Tipo:</label>
                        <select id="filterTipoSelect" class="form-select"></select>
                    </div>
                    <button id="clearFiltersBtn" class="btn btn-secondary"><i class="fa-solid fa-xmark"></i></button>
                </div>
                
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th class="checkbox-cell"><input type="checkbox" id="selectAllCheckbox"></th>
                                <th>Fecha</th>
                                <th>Banco</th>
                                <th>Punto de Venta</th>
                                <th>N° Aprobación</th>
                                <th>Valor</th>
                                <th>N° Cuenta</th>
                                <th>Tipo</th>
                                <th>Descripción</th>
                                <th>Hora Registro</th>
                            </tr>
                        </thead>
                        <tbody id="bancosTableBody"></tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const API_URL = 'https://damar-app.onrender.com';

        let masterData = [];
        let displayedData = [];
        let selectedRecordId = null;

        const bancoOptions = ["Bancolombia", "Banco de Bogotá", "Davivienda", "BBVA", "Banco Popular", "Scotiabank Colpatria", "Itaú", "Banco Caja Social", "Banco AV Villas", "Bancamía", "Banco Agrario", "Banco de Occidente", "Nequi", "Daviplata", "Otro"];
        const tipoOptions = ["Venta", "Compra", "Transferencia", "Retiro", "Depósito", "Pago", "Otro"];
        // CORRECCIÓN: Se actualiza la lista de puntos de venta.
        const puntoVentaOptions = ["Bodega medellin", "Volga tarde", "Volga madrugon", "Gran san", "Fábrica"];

        const dom = {
            fechaInput: document.getElementById('fechaInput'),
            bancoSelect: document.getElementById('bancoSelect'),
            puntoVentaSelect: document.getElementById('puntoVentaSelect'), // Se cambia de Input a Select
            aprobacionInput: document.getElementById('aprobacionInput'),
            valorInput: document.getElementById('valorInput'),
            cuentaInput: document.getElementById('cuentaInput'),
            tipoSelect: document.getElementById('tipoSelect'),
            descripcionInput: document.getElementById('descripcionInput'),
            tableBody: document.getElementById('bancosTableBody'),
            searchInput: document.getElementById('searchInput'),
            filterBancoSelect: document.getElementById('filterBancoSelect'),
            filterTipoSelect: document.getElementById('filterTipoSelect'),
            selectAllCheckbox: document.getElementById('selectAllCheckbox'),
            addBtn: document.getElementById('addBtn'),
            editBtn: document.getElementById('editBtn'),
            deleteBtn: document.getElementById('deleteBtn'),
            exportBtn: document.getElementById('exportBtn'),
            clearBtn: document.getElementById('clearBtn'),
            clearFiltersBtn: document.getElementById('clearFiltersBtn'),
            statTotalTransacciones: document.getElementById('statTotalTransacciones'),
            statTotalValor: document.getElementById('statTotalValor'),
            statMesActual: document.getElementById('statMesActual'),
            statPromedioDiario: document.getElementById('statPromedioDiario'),
        };

        const showToast = (message, type = 'success') => {
            const toastContainer = document.getElementById('toastContainer');
            const icon = type === 'success' ? 'fa-check-circle' : 'fa-times-circle';
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<i class="fas ${icon}"></i> ${message}`;
            toastContainer.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        };

        const showConfirmation = (message, onConfirm) => {
            const confirmModal = document.getElementById('confirmModal');
            document.getElementById('modalMessage').textContent = message;
            confirmModal.classList.add('active');
            const close = () => {
                confirmModal.classList.remove('active');
                document.getElementById('modalConfirmBtn').onclick = null;
                document.getElementById('modalCancelBtn').onclick = null;
            };
            document.getElementById('modalConfirmBtn').onclick = () => { close(); onConfirm(); };
            document.getElementById('modalCancelBtn').onclick = close;
        };
        
        const setButtonsLoading = (loading) => {
            [dom.addBtn, dom.editBtn, dom.deleteBtn, dom.exportBtn].forEach(btn => btn.disabled = loading);
        };

        const formatCurrency = (value) => {
            const num = parseFloat(value) || 0;
            return num.toLocaleString('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0, maximumFractionDigits: 0 });
        };

        async function apiRequest(endpoint, method = 'GET', data = null) {
            setButtonsLoading(true);
            try {
                const options = {
                    method,
                    headers: { 'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true' },
                    mode: 'cors',
                };
                if (data) options.body = JSON.stringify(data);
                const response = await fetch(`${API_URL}${endpoint}`, options);
                const responseData = await response.json();
                if (!response.ok) throw new Error(responseData.message || `Error del servidor: ${response.status}`);
                return responseData;
            } catch (error) {
                showToast(error.message, 'error');
                throw error;
            } finally {
                setButtonsLoading(false);
            }
        }

        function populateSelect(selectElement, options, firstOptionText = null) {
            let html = firstOptionText ? `<option value="">${firstOptionText}</option>` : '';
            html += options.map(opt => `<option value="${opt}">${opt}</option>`).join('');
            selectElement.innerHTML = html;
        }

        function collectFormData() {
            const valor_str = dom.valorInput.value.replace(/[^0-9]/g, '');
            return {
                fecha: dom.fechaInput.value,
                banco: dom.bancoSelect.value,
                punto_venta: dom.puntoVentaSelect.value, // Se obtiene del select
                aprobacion: dom.aprobacionInput.value.trim(),
                valor: parseFloat(valor_str) || 0,
                cuenta: dom.cuentaInput.value.trim(),
                tipo: dom.tipoSelect.value,
                descripcion: dom.descripcionInput.value.trim()
            };
        }

        function validateForm() {
            const data = collectFormData();
            if (!data.fecha || !data.banco || !data.aprobacion || !data.tipo) {
                showToast("Fecha, Banco, N° Aprobación y Tipo son obligatorios.", 'error');
                return false;
            }
            if (data.valor <= 0) {
                showToast("El valor debe ser mayor a cero.", 'error');
                return false;
            }
            return true;
        }
        
        function clearForm() {
            selectedRecordId = null;
            dom.fechaInput.valueAsDate = new Date();
            dom.bancoSelect.value = "";
            dom.puntoVentaSelect.value = ""; // Limpiar select
            dom.aprobacionInput.value = '';
            dom.valorInput.value = '';
            dom.cuentaInput.value = '';
            dom.tipoSelect.value = "";
            dom.descripcionInput.value = '';
            dom.aprobacionInput.disabled = false;
            document.querySelectorAll('.data-table tr.selected').forEach(row => row.classList.remove('selected'));
        }

        function renderTable(dataToRender) {
            dom.tableBody.innerHTML = '';
            if (dataToRender.length === 0) {
                dom.tableBody.innerHTML = `<tr><td colspan="10" class="feedback-state"><i class="fa-solid fa-search"></i> No se encontraron registros.</td></tr>`;
            } else {
                dataToRender.forEach(record => {
                    const tr = document.createElement('tr');
                    tr.dataset.id = record.id;
                    tr.onclick = (e) => { if (e.target.type !== 'checkbox') selectRecord(tr, record.id); };
                    const horaRegistro = (record.fecha_registro || ' ').split(' ')[1] || '';
                    tr.innerHTML = `
                        <td class="checkbox-cell"><input type="checkbox" data-id="${record.id}"></td>
                        <td>${record.fecha}</td>
                        <td>${record.banco}</td>
                        <td>${record.punto_venta || 'N/A'}</td>
                        <td>${record.aprobacion}</td>
                        <td>${formatCurrency(record.valor)}</td>
                        <td>${record.cuenta || 'N/A'}</td>
                        <td>${record.tipo}</td>
                        <td>${record.descripcion || 'N/A'}</td>
                        <td>${horaRegistro}</td>
                    `;
                    dom.tableBody.appendChild(tr);
                });
            }
        }

        function updateStatistics(data) {
            if (!Array.isArray(data)) return;
            dom.statTotalTransacciones.textContent = data.length;
            const totalValor = data.reduce((sum, b) => sum + (parseFloat(b.valor) || 0), 0);
            dom.statTotalValor.textContent = formatCurrency(totalValor);
            
            const now = new Date();
            const currentMonthStr = now.toISOString().slice(0, 7);
            const mesActualValor = data
                .filter(b => b.fecha && b.fecha.startsWith(currentMonthStr))
                .reduce((sum, b) => sum + (parseFloat(b.valor) || 0), 0);
            dom.statMesActual.textContent = formatCurrency(mesActualValor);

            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(now.getDate() - 30);
            const recentTransactions = data.filter(b => b.fecha && new Date(b.fecha) >= thirtyDaysAgo);
            const valorUltimos30dias = recentTransactions.reduce((sum, b) => sum + (parseFloat(b.valor) || 0), 0);
            dom.statPromedioDiario.textContent = formatCurrency(valorUltimos30dias / 30);
        }

        function applyFiltersAndRender() {
            const searchTerm = dom.searchInput.value.toLowerCase().trim();
            const bancoFilter = dom.filterBancoSelect.value;
            const tipoFilter = dom.filterTipoSelect.value;

            displayedData = masterData.filter(b => {
                const searchMatch = !searchTerm || ['banco', 'punto_venta', 'aprobacion', 'descripcion'].some(key => String(b[key] || '').toLowerCase().includes(searchTerm));
                const bancoMatch = !bancoFilter || b.banco === bancoFilter;
                const tipoMatch = !tipoFilter || b.tipo === tipoFilter;
                return searchMatch && bancoMatch && tipoMatch;
            });
            
            renderTable(displayedData);
            updateStatistics(displayedData);
        }

        async function loadInitialData() {
            renderTable([]); // Clear table initially
            updateStatistics([]);
            dom.tableBody.innerHTML = `<tr><td colspan="10" class="feedback-state"><div class="loading-spinner"></div>Cargando datos...</td></tr>`;
            try {
                const data = await apiRequest('/bancos');
                masterData = data || [];
                applyFiltersAndRender();
            } catch (error) {
                dom.tableBody.innerHTML = `<tr><td colspan="10" class="feedback-state"><i class="fa-solid fa-circle-exclamation"></i> No se pudieron cargar los registros.</td></tr>`;
            }
        }

        async function addRecord() {
            if (!validateForm()) return;
            try {
                const data = collectFormData();
                const result = await apiRequest('/bancos', 'POST', data);
                showToast(result.message, 'success');
                clearForm();
                await loadInitialData();
            } catch (error) {}
        }

        async function editRecord() {
            if (selectedRecordId === null) {
                showToast('Seleccione una transacción para editar.', 'error');
                return;
            }
            if (!validateForm()) return;
            try {
                const data = collectFormData();
                const result = await apiRequest(`/bancos/${selectedRecordId}`, 'PUT', data);
                showToast(result.message, 'success');
                clearForm();
                await loadInitialData();
            } catch (error) {}
        }
        
        async function deleteSelectedRecords() {
            const checkedBoxes = dom.tableBody.querySelectorAll('input[type="checkbox"]:checked');
            if (checkedBoxes.length === 0) {
                showToast('Seleccione al menos una transacción para eliminar.', 'error');
                return;
            }
            const idsToDelete = Array.from(checkedBoxes).map(cb => cb.dataset.id);
            showConfirmation(`¿Está seguro de que desea eliminar ${idsToDelete.length} transacción(es)?`, async () => {
                try {
                    const result = await apiRequest('/bancos', 'DELETE', { ids: idsToDelete });
                    showToast(result.message, 'success');
                    clearForm();
                    await loadInitialData();
                } catch (error) {}
            });
        }
        
        function exportToExcel() {
            if (displayedData.length === 0) {
                showToast("No hay datos para exportar.", 'error');
                return;
            }
            const worksheet = XLSX.utils.json_to_sheet(displayedData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Transacciones");
            XLSX.writeFile(workbook, "Reporte_Bancos.xlsx");
            showToast("Datos exportados a Excel.", "success");
        }

        function selectRecord(rowElement, recordId) {
            selectedRecordId = recordId;
            const record = masterData.find(b => String(b.id) === String(recordId));
            if (!record) return;

            dom.fechaInput.value = record.fecha;
            dom.bancoSelect.value = record.banco;
            dom.puntoVentaSelect.value = record.punto_venta; // Se asigna al select
            dom.aprobacionInput.value = record.aprobacion;
            dom.aprobacionInput.disabled = true;
            dom.valorInput.value = (parseFloat(record.valor) || 0).toLocaleString('es-CO');
            dom.cuentaInput.value = record.cuenta;
            dom.tipoSelect.value = record.tipo;
            dom.descripcionInput.value = record.descripcion;
            
            document.querySelectorAll('.data-table tr.selected').forEach(row => row.classList.remove('selected'));
            rowElement.classList.add('selected');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        function init() {
            populateSelect(dom.bancoSelect, bancoOptions, "Seleccione un banco...");
            populateSelect(dom.tipoSelect, tipoOptions, "Seleccione un tipo...");
            populateSelect(dom.filterBancoSelect, bancoOptions, "Todos los bancos");
            populateSelect(dom.filterTipoSelect, tipoOptions, "Todos los tipos");
            // CORRECCIÓN: Se puebla el nuevo select de Puntos de Venta
            populateSelect(dom.puntoVentaSelect, puntoVentaOptions, "Seleccione un punto de venta...");

            dom.addBtn.addEventListener('click', addRecord);
            dom.editBtn.addEventListener('click', editRecord);
            dom.deleteBtn.addEventListener('click', deleteSelectedRecords);
            dom.exportBtn.addEventListener('click', exportToExcel);
            dom.clearBtn.addEventListener('click', clearForm);
            dom.clearFiltersBtn.addEventListener('click', () => {
                dom.searchInput.value = '';
                dom.filterBancoSelect.value = '';
                dom.filterTipoSelect.value = '';
                applyFiltersAndRender();
            });
            
            [dom.searchInput, dom.filterBancoSelect, dom.filterTipoSelect].forEach(el => el.addEventListener('change', applyFiltersAndRender));
            dom.searchInput.addEventListener('input', applyFiltersAndRender);
            
            dom.selectAllCheckbox.addEventListener('change', (e) => {
                dom.tableBody.querySelectorAll('input[type="checkbox"]').forEach(checkbox => checkbox.checked = e.target.checked);
            });

            dom.valorInput.addEventListener('input', (e) => {
                let rawValue = e.target.value.replace(/[^0-9]/g, '');
                if (rawValue) {
                    e.target.value = parseFloat(rawValue).toLocaleString('es-CO');
                } else {
                    e.target.value = '';
                }
            });

            clearForm();
            loadInitialData();
        }
        
        init();
    });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Llegada de Material - DAMAR</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root {
            --primary-dark: #2C3E50; --secondary-light: #ECF0F1; --accent: #3498DB;
            --text-dark: #34495E; --text-light: white; --hover-accent: #2980B9;
            --success: #27AE60; --warning: #F39C12; --danger: #E74C3C;
            --border-color: #dfe4ea; --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --shadow: 0 10px 30px rgba(44, 62, 80, 0.1); --shadow-hover: 0 15px 35px rgba(44, 62, 80, 0.15);
            --font-family: 'Poppins', sans-serif; --border-radius-lg: 12px; --border-radius-md: 8px;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; }
        body {
            font-family: var(--font-family); background-color: var(--secondary-light); color: var(--text-dark);
            line-height: 1.6; animation: fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .container { max-width: 1400px; margin: 2rem auto; padding: 0 1.5rem; }
        .card {
            background-color: white; border-radius: var(--border-radius-lg); padding: 2.5rem;
            margin-bottom: 2rem; box-shadow: var(--shadow); border: 1px solid var(--border-color);
        }
        .content-header { text-align: center; margin-bottom: 2.5rem; }
        .content-title { font-size: 2.5rem; font-weight: 700; color: var(--primary-dark); margin-bottom: 0.5rem; }
        .content-subtitle { font-size: 1.1rem; color: var(--text-dark); max-width: 700px; margin: 0 auto; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1.5rem 2rem; }
        .form-group { display: flex; flex-direction: column; }
        .form-label { font-weight: 600; margin-bottom: 0.6rem; color: var(--primary-dark); font-size: 0.9rem; }
        .form-input, .form-select {
            width: 100%; padding: 12px 16px; border: 1px solid var(--border-color);
            border-radius: var(--border-radius-md); background-color: #fdfdfe; color: var(--text-dark);
            font-size: 1rem; font-family: var(--font-family); transition: all 0.3s ease;
        }
        .form-input:focus, .form-select:focus {
            outline: none; border-color: var(--accent); background-color: white;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.15);
        }
        .image-preview-group { text-align: center; }
        #imagePreview {
            width: 100%; height: 150px; background-color: var(--secondary-light);
            border: 2px dashed var(--border-color); border-radius: var(--border-radius-md);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; overflow: hidden; transition: background-color 0.3s, border-color 0.3s; position: relative;
        }
        #imagePreview:hover { background-color: #e0e6ed; border-color: var(--accent); }
        #imagePreview img { max-width: 100%; max-height: 100%; object-fit: cover; }
        #imagePreview span { color: #909db1; font-size: 0.9rem; }
        #imageInput { display: none; }
        .buttons-container { display: flex; flex-wrap: wrap; gap: 1rem; margin-top: 2rem; border-top: 1px solid var(--border-color); padding-top: 2rem; justify-content: center; }
        .btn {
            border: none; border-radius: var(--border-radius-md); padding: 12px 24px; font-size: 0.95rem;
            font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; justify-content: center;
            gap: 0.75rem; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: var(--shadow-hover); }
        .btn:disabled { background-color: #bdc3c7; cursor: not-allowed; transform: none; box-shadow: none; opacity: 0.6; }
        .btn-primary { background: var(--gradient-primary); color: white; }
        .btn-success { background-color: var(--success); color: white; }
        .btn-danger { background-color: var(--danger); color: white; }
        .btn-secondary { background-color: #bdc3c7; color: var(--text-dark); }
        .search-controls { display: flex; gap: 1rem; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; }
        .search-wrapper { position: relative; flex-grow: 1; }
        .search-icon { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: #909db1; }
        .search-input { width: 100%; padding-left: 3rem; }
        .table-container { overflow-x: auto; }
        .data-table { width: 100%; border-collapse: collapse; text-align: left; }
        .data-table th, .data-table td { padding: 14px 18px; vertical-align: middle; border-bottom: 1px solid var(--border-color); white-space: nowrap; }
        .data-table thead th { background-color: #f8f9fa; color: var(--primary-dark); font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .data-table tbody tr { transition: background-color 0.2s ease; }
        .data-table tbody tr:hover { background-color: #f5f5f5; cursor: pointer; }
        .data-table tr.selected { background-color: rgba(52, 152, 219, 0.1) !important; box-shadow: inset 4px 0 0 0 var(--accent); }
        .data-table .checkbox-cell { text-align: center; }
        .data-table .img-cell { width: 60px; height: 40px; object-fit: cover; border-radius: 4px; cursor: zoom-in; }
        .feedback-state { text-align: center; padding: 4rem 1rem; font-size: 1.1rem; color: #6c757d; }
        .feedback-state i { font-size: 2.5rem; display: block; margin-bottom: 1rem; color: var(--accent); }
        .loading-spinner, .image-spinner { width: 30px; height: 30px; border: 3px solid rgba(0,0,0,0.2); border-top-color: var(--text-light); border-radius: 50%; animation: spin 1s linear infinite; }
        .table-loading-spinner { width: 50px; height: 50px; border-width: 4px; margin: 0 auto 1rem;}
        #imagePreview .image-spinner { position: absolute; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 1050; }
        .toast { display: flex; align-items: center; padding: 15px 20px; border-radius: var(--border-radius-md); color: white; font-weight: 500; margin-bottom: 10px; box-shadow: var(--shadow); transform: translateX(120%); animation: slideIn 0.5s forwards; }
        .toast.success { background-color: var(--success); }
        .toast.error { background-color: var(--danger); }
        .toast i { margin-right: 10px; font-size: 1.2rem; }
        @keyframes slideIn { to { transform: translateX(0); } }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s ease; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-content { background: white; padding: 2rem; border-radius: var(--border-radius-lg); width: 90%; max-width: 500px; text-align: center; transform: scale(0.9); transition: all 0.3s ease; }
        .modal-overlay.active .modal-content { transform: scale(1); }
        .modal-content h3 { margin-bottom: 1rem; color: var(--primary-dark); }
        .modal-content p { margin-bottom: 2rem; color: var(--text-dark); }
        .modal-buttons { display: flex; justify-content: center; gap: 1rem; }
        #imageModal.active { opacity: 1; visibility: visible; }
        #imageModal .modal-content { max-width: 90vw; max-height: 90vh; padding: 0; background: transparent; }
        #imageModal img { width: 100%; height: 100%; object-fit: contain; }
        @media (max-width: 768px) {
            .container { margin: 1rem auto; padding: 0 1rem; }
            .card { padding: 1.5rem; }
            .content-title { font-size: 2rem; }
            .buttons-container, .search-controls { flex-direction: column; align-items: stretch; }
            .btn, .form-input, .form-select { width: 100%; }
        }
    </style>
</head>
<body>

    <div id="toastContainer" class="toast-container"></div>
    <div id="confirmModal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modalTitle">Confirmar Acción</h3>
            <p id="modalMessage">¿Estás seguro?</p>
            <div class="modal-buttons">
                <button id="modalCancelBtn" class="btn btn-secondary">Cancelar</button>
                <button id="modalConfirmBtn" class="btn btn-danger">Confirmar</button>
            </div>
        </div>
    </div>
    <div id="imageModal" class="modal-overlay">
        <div class="modal-content">
            <img id="fullImage" src="" alt="Vista ampliada">
        </div>
    </div>

    <div class="container">
        <header class="content-header">
            <h1 class="content-title">Gestión de Llegada de Material</h1>
            <p class="content-subtitle">Registre y administre la entrada de materiales, proveedores e inventario inicial.</p>
        </header>
        
        <main>
            <section class="card">
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label" for="fechaInput">Fecha Ingreso</label>
                        <input type="date" id="fechaInput" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="referenciaInput">Referencia / Cód. Barras</label>
                        <input type="text" id="referenciaInput" class="form-input" placeholder="Escriba o seleccione una opción" list="referencesDatalist">
                        <datalist id="referencesDatalist"></datalist>
                    </div>
                     <div class="form-group">
                        <label class="form-label" for="materialInput">Material</label>
                        <input type="text" id="materialInput" class="form-input" placeholder="Ej: Hilo, Botones, Marquilla">
                    </div>
                     <div class="form-group image-preview-group">
                         <label class="form-label" for="imageInput">Imagen del Material</label>
                         <input type="file" id="imageInput" accept="image/*">
                         <label for="imageInput" id="imagePreview">
                             <span>Clic para subir imagen</span>
                         </label>
                     </div>
                    <div class="form-group">
                        <label class="form-label" for="sizeInput">Tamaño</label>
                        <input type="text" id="sizeInput" class="form-input" placeholder="Ej: 5, 10, Grande">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="sizeUnitInput">Unidad de Tamaño</label>
                        <input type="text" id="sizeUnitInput" class="form-input" placeholder="Ej: mm, cm, unidades">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="quantityInput">Cantidad</label>
                        <input type="number" id="quantityInput" class="form-input" placeholder="Valor numérico">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="quantityTypeSelect">Tipo de Cantidad</label>
                        <select id="quantityTypeSelect" class="form-select">
                            <option>Unidades</option>
                            <option>Metros</option>
                            <option>Kilos</option>
                            <option>Rollos</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="supplierInput">Proveedor</label>
                        <input type="text" id="supplierInput" class="form-input" placeholder="Nombre del proveedor">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="invoiceValueInput">Valor Factura (COP)</label>
                        <input type="text" id="invoiceValueInput" class="form-input" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="unitValueInput">Valor por Unidad (COP)</label>
                        <input type="text" id="unitValueInput" class="form-input" placeholder="0">
                    </div>
                </div>
        
                <div class="buttons-container">
                    <button id="addBtn" class="btn btn-primary"><i class="fa-solid fa-plus"></i> Registrar</button>
                    <button id="editBtn" class="btn btn-success"><i class="fa-solid fa-pen-to-square"></i> Guardar Cambios</button>
                    <button id="deleteBtn" class="btn btn-danger"><i class="fa-solid fa-trash-can"></i> Eliminar</button>
                    <button id="clearBtn" class="btn btn-secondary"><i class="fa-solid fa-eraser"></i> Limpiar</button>
                </div>
            </section>
            
            <section class="card">
                <div class="search-controls">
                    <div class="search-wrapper">
                        <i class="fa-solid fa-magnifying-glass search-icon"></i>
                        <input type="text" id="searchInput" class="form-input search-input" placeholder="Buscar por Material, Proveedor o Referencia...">
                    </div>
                    <input type="date" id="searchDateInput" class="form-input">
                    <button id="clearSearchBtn" class="btn btn-secondary"><i class="fa-solid fa-xmark"></i></button>
                </div>
                
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="selectAllCheckbox"></th>
                                <th>Fecha</th>
                                <th>Material</th>
                                <th>Referencia</th>
                                <th>Tamaño</th>
                                <th>Unidad</th>
                                <th>Cant.</th>
                                <th>Tipo</th>
                                <th>Proveedor</th>
                                <th>V. Factura</th>
                                <th>V. Unidad</th>
                                <th>Imagen</th>
                            </tr>
                        </thead>
                        <tbody id="materialsTableBody"></tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const API_URL = 'https://damar-app.onrender.com';
        // Se elimina la clave de API real para no exponerla. La función de carga será simulada.
        // const IMAGEBB_API_KEY = 'd482776ffb2a6adc337a1074c9f27732';

        let masterData = [];
        let displayedData = [];
        let selectedRecordId = null;

        const dom = {
            fechaInput: document.getElementById('fechaInput'),
            referenciaInput: document.getElementById('referenciaInput'),
            materialInput: document.getElementById('materialInput'),
            imageInput: document.getElementById('imageInput'),
            imagePreview: document.getElementById('imagePreview'),
            sizeInput: document.getElementById('sizeInput'),
            sizeUnitInput: document.getElementById('sizeUnitInput'),
            quantityInput: document.getElementById('quantityInput'),
            quantityTypeSelect: document.getElementById('quantityTypeSelect'),
            supplierInput: document.getElementById('supplierInput'),
            invoiceValueInput: document.getElementById('invoiceValueInput'),
            unitValueInput: document.getElementById('unitValueInput'),
            tableBody: document.getElementById('materialsTableBody'),
            searchInput: document.getElementById('searchInput'),
            searchDateInput: document.getElementById('searchDateInput'),
            selectAllCheckbox: document.getElementById('selectAllCheckbox'),
            addBtn: document.getElementById('addBtn'),
            editBtn: document.getElementById('editBtn'),
            deleteBtn: document.getElementById('deleteBtn'),
            clearBtn: document.getElementById('clearBtn'),
            clearSearchBtn: document.getElementById('clearSearchBtn'),
            imageModal: document.getElementById('imageModal'),
            fullImage: document.getElementById('fullImage'),
        };

        const showToast = (message, type = 'success') => {
            const toastContainer = document.getElementById('toastContainer');
            const icon = type === 'success' ? 'fa-check-circle' : 'fa-times-circle';
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<i class="fas ${icon}"></i> ${message}`;
            toastContainer.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        };

        const showConfirmation = (message, onConfirm) => {
            const confirmModal = document.getElementById('confirmModal');
            document.getElementById('modalMessage').textContent = message;
            confirmModal.classList.add('active');
            const close = () => {
                confirmModal.classList.remove('active');
                document.getElementById('modalConfirmBtn').onclick = null;
                document.getElementById('modalCancelBtn').onclick = null;
            };
            document.getElementById('modalConfirmBtn').onclick = () => { close(); onConfirm(); };
            document.getElementById('modalCancelBtn').onclick = close;
        };

        const setButtonsLoading = (loading) => {
            [dom.addBtn, dom.editBtn, dom.deleteBtn].forEach(btn => btn.disabled = loading);
        };

        const formatCurrency = (value) => {
            const num = parseFloat(value) || 0;
            return num.toLocaleString('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0, maximumFractionDigits: 0 });
        };

        const parseCurrency = (value) => {
            return value.replace(/[^0-9]/g, '');
        };

        async function apiRequest(endpoint, method = 'GET', data = null) {
            setButtonsLoading(true);
            try {
                const options = {
                    method,
                    headers: { 'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true' },
                    mode: 'cors',
                };
                if (data) options.body = JSON.stringify(data);
                const response = await fetch(`${API_URL}${endpoint}`, options);
                const responseData = await response.json();
                if (!response.ok) throw new Error(responseData.message || `Error del servidor: ${response.status}`);
                return responseData;
            } catch (error) {
                showToast(error.message, 'error');
                throw error;
            } finally {
                setButtonsLoading(false);
            }
        }
        
        // --- INICIO DEL BLOQUE CORREGIDO ---
        // Se modifica esta función para simular la carga de imágenes sin una API Key real.
        async function uploadImageToHost(file) {
            dom.imagePreview.innerHTML = '<div class="image-spinner"></div>';
            console.log("Simulando carga de imagen para el archivo:", file.name);

            // Simula un retraso de red de 1.5 segundos
            await new Promise(resolve => setTimeout(resolve, 1500));

            // Simula una respuesta exitosa con una URL de imagen de marcador de posición.
            const simulatedResult = {
                success: true,
                data: {
                    // Se usa una imagen de ejemplo. En un caso real, esta URL provendría de la API.
                    url: 'https://i.ibb.co/6Zf1Jm1/placeholder.png' 
                }
            };
            
            // Procesa el resultado simulado
            if (simulatedResult.success) {
                const imageUrl = simulatedResult.data.url;
                dom.imagePreview.innerHTML = `<img src="${imageUrl}" alt="Vista previa">`;
                dom.imagePreview.dataset.imageUrl = imageUrl;
                showToast('Imagen subida (simulada) correctamente.', 'success');
            } else {
                showToast('Hubo un error simulado al subir la imagen.', 'error');
                dom.imagePreview.innerHTML = '<span>Error al subir. Intente de nuevo.</span>';
            }
        }
        // --- FIN DEL BLOQUE CORREGIDO ---

        function collectFormData() {
            return {
                entry_date: dom.fechaInput.value,
                barcode: dom.referenciaInput.value.trim(),
                material_name: dom.materialInput.value.trim(),
                size_value: dom.sizeInput.value.trim(),
                size_unit: dom.sizeUnitInput.value.trim(),
                quantity_value: parseFloat(dom.quantityInput.value) || 0,
                quantity_type: dom.quantityTypeSelect.value,
                supplier: dom.supplierInput.value.trim(),
                invoice_value: parseFloat(parseCurrency(dom.invoiceValueInput.value)) || 0,
                unit_value: parseFloat(parseCurrency(dom.unitValueInput.value)) || 0,
                image_path: dom.imagePreview.dataset.imageUrl || null
            };
        }

        function validateForm() {
            const data = collectFormData();
            if (!data.entry_date || !data.material_name || !data.supplier) {
                showToast('Fecha, Material y Proveedor son obligatorios.', 'error');
                return false;
            }
            return true;
        }

        function clearForm() {
            selectedRecordId = null;
            dom.fechaInput.valueAsDate = new Date();
            ['referenciaInput', 'materialInput', 'sizeInput', 'sizeUnitInput', 'quantityInput', 'supplierInput', 'invoiceValueInput', 'unitValueInput'].forEach(key => dom[key].value = '');
            dom.quantityTypeSelect.value = 'Unidades';
            dom.imageInput.value = '';
            dom.imagePreview.innerHTML = '<span>Clic para subir imagen</span>';
            delete dom.imagePreview.dataset.imageUrl;
            document.querySelectorAll('.data-table tr.selected').forEach(row => row.classList.remove('selected'));
        }

        function renderTable(dataToRender) {
            dom.tableBody.innerHTML = '';
            if (dataToRender.length === 0) {
                dom.tableBody.innerHTML = `<tr><td colspan="12" class="feedback-state"><i class="fa-solid fa-box-open"></i> No se encontraron registros.</td></tr>`;
            } else {
                dataToRender.forEach(record => {
                    const tr = document.createElement('tr');
                    tr.dataset.id = record.id;
                    tr.onclick = (e) => { if (e.target.type !== 'checkbox' && e.target.tagName !== 'IMG') selectRecord(tr, record.id); };
                    
                    const imageHtml = record.image_path 
                        ? `<img src="${record.image_path}" class="img-cell" alt="Material" onclick="showImageModal('${record.image_path}')">` 
                        : 'Sin imagen';

                    tr.innerHTML = `
                        <td class="checkbox-cell"><input type="checkbox" data-id="${record.id}"></td>
                        <td>${record.entry_date}</td>
                        <td>${record.material_name || 'N/A'}</td>
                        <td>${record.barcode || 'N/A'}</td>
                        <td>${record.size_value || 'N/A'}</td>
                        <td>${record.size_unit || 'N/A'}</td>
                        <td>${record.quantity_value}</td>
                        <td>${record.quantity_type}</td>
                        <td>${record.supplier || 'N/A'}</td>
                        <td>${formatCurrency(record.invoice_value)}</td>
                        <td>${formatCurrency(record.unit_value)}</td>
                        <td>${imageHtml}</td>
                    `;
                    dom.tableBody.appendChild(tr);
                });
            }
        }

        function applyFiltersAndRender() {
            const searchTerm = dom.searchInput.value.toLowerCase().trim();
            const searchDate = dom.searchDateInput.value;
            
            displayedData = masterData.filter(record => {
                const searchMatch = !searchTerm || ['material_name', 'supplier', 'barcode'].some(key => String(record[key] || '').toLowerCase().includes(searchTerm));
                const dateMatch = !searchDate || record.entry_date === searchDate;
                return searchMatch && dateMatch;
            });
            renderTable(displayedData);
        }

        async function loadInitialData() {
            dom.tableBody.innerHTML = `<tr><td colspan="12" class="feedback-state"><div class="loading-spinner table-loading-spinner"></div>Cargando...</td></tr>`;
            try {
                const data = await apiRequest('/materials');
                masterData = data || [];
                applyFiltersAndRender();
            } catch (error) {
                dom.tableBody.innerHTML = `<tr><td colspan="12" class="feedback-state"><i class="fa-solid fa-circle-exclamation"></i> No se pudieron cargar los registros.</td></tr>`;
            }
        }

        async function loadAutocompleteOptions() {
            try {
                const [materialReferences, materialBarcodes] = await Promise.all([
                    apiRequest('/dynamic-codes/references/materiales'),
                    apiRequest('/dynamic-codes/barcodes/materiales')
                ]);

                const datalist = document.getElementById('referencesDatalist');
                datalist.innerHTML = ''; 

                const uniqueCodes = new Set();
                (materialReferences || []).forEach(item => item.code && uniqueCodes.add(item.code));
                (materialBarcodes || []).forEach(item => item.code && uniqueCodes.add(item.code));

                uniqueCodes.forEach(code => {
                    const option = document.createElement('option');
                    option.value = code;
                    datalist.appendChild(option);
                });
            } catch (error) {
                console.error('Error al cargar opciones de autocompletado:', error);
            }
        }

        async function addRecord() {
            if (!validateForm()) return;
            try {
                const data = collectFormData();
                const result = await apiRequest('/materials', 'POST', data);
                showToast(result.message, 'success');
                clearForm();
                await loadInitialData();
            } catch (error) {}
        }

        async function editRecord() {
            if (selectedRecordId === null) {
                showToast('Seleccione un registro para editar.', 'error');
                return;
            }
            if (!validateForm()) return;
            try {
                const data = collectFormData();
                const result = await apiRequest(`/materials/${selectedRecordId}`, 'PUT', data);
                showToast(result.message, 'success');
                clearForm();
                await loadInitialData();
            } catch (error) {}
        }
        
        async function deleteSelectedRecords() {
            const checkedBoxes = dom.tableBody.querySelectorAll('input[type="checkbox"]:checked');
            if (checkedBoxes.length === 0) {
                showToast('Seleccione al menos un registro para eliminar.', 'error');
                return;
            }
            const idsToDelete = Array.from(checkedBoxes).map(cb => cb.dataset.id);
            showConfirmation(`¿Está seguro de que desea eliminar ${idsToDelete.length} registro(s)?`, async () => {
                try {
                    const result = await apiRequest('/materials', 'DELETE', { ids: idsToDelete });
                    showToast(result.message, 'success');
                    clearForm();
                    await loadInitialData();
                } catch (error) {}
            });
        }

        function selectRecord(rowElement, recordId) {
            selectedRecordId = recordId;
            const record = masterData.find(m => String(m.id) === String(recordId));
            if (!record) return;

            dom.fechaInput.value = record.entry_date;
            dom.referenciaInput.value = record.barcode;
            dom.materialInput.value = record.material_name;
            dom.sizeInput.value = record.size_value;
            dom.sizeUnitInput.value = record.size_unit;
            dom.quantityInput.value = record.quantity_value;
            dom.quantityTypeSelect.value = record.quantity_type;
            dom.supplierInput.value = record.supplier;
            dom.invoiceValueInput.value = formatCurrency(record.invoice_value).replace('$', '').trim();
            dom.unitValueInput.value = formatCurrency(record.unit_value).replace('$', '').trim();
            
            dom.imagePreview.innerHTML = '';
            delete dom.imagePreview.dataset.imageUrl;
            if (record.image_path) {
                const img = document.createElement('img');
                img.src = record.image_path;
                dom.imagePreview.appendChild(img);
                dom.imagePreview.dataset.imageUrl = record.image_path;
            } else {
                dom.imagePreview.innerHTML = '<span>Clic para subir imagen</span>';
            }
            
            document.querySelectorAll('.data-table tr.selected').forEach(row => row.classList.remove('selected'));
            rowElement.classList.add('selected');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        window.showImageModal = (src) => {
            dom.fullImage.src = src;
            dom.imageModal.classList.add('active');
        };

        function init() {
            dom.addBtn.addEventListener('click', addRecord);
            dom.editBtn.addEventListener('click', editRecord);
            dom.deleteBtn.addEventListener('click', deleteSelectedRecords);
            dom.clearBtn.addEventListener('click', clearForm);
            dom.clearSearchBtn.addEventListener('click', () => {
                dom.searchInput.value = '';
                dom.searchDateInput.value = '';
                applyFiltersAndRender();
            });
            
            [dom.searchInput, dom.searchDateInput].forEach(el => el.addEventListener('input', applyFiltersAndRender));
            
            dom.selectAllCheckbox.addEventListener('change', (e) => {
                dom.tableBody.querySelectorAll('input[type="checkbox"]').forEach(checkbox => checkbox.checked = e.target.checked);
            });

            dom.imageInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    uploadImageToHost(file);
                }
            });

            [dom.invoiceValueInput, dom.unitValueInput].forEach(input => {
                input.addEventListener('input', (e) => {
                    let value = parseCurrency(e.target.value);
                    e.target.value = formatCurrency(value).replace('$', '').trim();
                });
            });

            dom.imageModal.addEventListener('click', () => dom.imageModal.classList.remove('active'));

            clearForm();
            loadInitialData();
            loadAutocompleteOptions(); 
        }
        
        init();
    });
    </script>
</body>
</html>
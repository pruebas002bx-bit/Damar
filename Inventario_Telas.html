<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventario de Telas - DAMAR</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        :root {
            --primary-dark: #2C3E50; --secondary-light: #f8f9fa; --accent: #3498DB;
            --text-dark: #34495E; --success: #27AE60; --danger: #E74C3C;
            --border-color: #dee2e6; --shadow: 0 4px 15px rgba(0, 0, 0, 0.07);
            --font-family: 'Poppins', sans-serif; --border-radius: 8px;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: var(--font-family); background-color: var(--secondary-light); color: var(--text-dark); }
        .container { max-width: 1400px; margin: 2rem auto; padding: 0 1.5rem; }
        .header { text-align: center; margin-bottom: 2rem; }
        .title { font-size: 2.5rem; font-weight: 700; color: var(--primary-dark); }
        .controls {
            display: flex; justify-content: space-between; align-items: center;
            gap: 1rem; flex-wrap: wrap; margin-bottom: 1.5rem;
            padding: 1.5rem; background-color: white; border-radius: var(--border-radius);
            box-shadow: var(--shadow); border: 1px solid var(--border-color);
        }
        .search-wrapper { position: relative; flex-grow: 1; min-width: 250px; }
        .search-icon { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: #909db1; }
        .search-input {
            width: 100%; padding: 12px 16px 12px 3rem; border: 1px solid var(--border-color);
            border-radius: var(--border-radius); font-size: 1rem; transition: all 0.3s ease;
        }
        .search-input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.15); }
        .btn {
            border: none; border-radius: var(--border-radius); padding: 12px 24px; font-size: 0.95rem; font-weight: 600;
            cursor: pointer; display: inline-flex; align-items: center; justify-content: center;
            gap: 0.5rem; transition: all 0.3s ease;
        }
        .btn-primary { background-color: var(--accent); color: white; }
        .btn-primary:hover { background-color: #2980B9; }
        .table-container { overflow-x: auto; background: white; border-radius: var(--border-radius); box-shadow: var(--shadow); border: 1px solid var(--border-color); }
        .data-table { width: 100%; border-collapse: collapse; text-align: left; }
        .data-table th, .data-table td { padding: 16px 20px; vertical-align: middle; border-bottom: 1px solid var(--border-color); white-space: nowrap; }
        .data-table thead th {
            background-color: #f8f9fa; color: var(--primary-dark); font-size: 13px;
            font-weight: 600; text-transform: uppercase; user-select: none;
        }
        .data-table thead th .sort-indicator {
            display: inline-block; margin-left: 5px; color: #ced4da;
            transition: color 0.2s;
        }
        .data-table thead th:hover { cursor: pointer; background-color: #f1f3f5; }
        .data-table thead th.sorted .sort-indicator { color: var(--accent); }
        .data-table tbody tr:last-child td { border-bottom: none; }
        .data-table tbody tr:hover { background-color: #f5f5f5; }
        .color-cell { width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--border-color); background-size: cover; background-position: center; }
        .feedback-state { text-align: center; padding: 4rem 1rem; font-size: 1.1rem; color: #6c757d; }
        .feedback-state i { font-size: 2.5rem; display: block; margin-bottom: 1rem; color: var(--accent); }
        .loading-spinner { width: 50px; height: 50px; border: 4px solid var(--border-color); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin: 2rem auto; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1 class="title"><i class="fa-solid fa-warehouse"></i> Inventario General de Telas</h1>
        </header>
        <main>
            <div class="controls">
                <div class="search-wrapper">
                    <i class="fa-solid fa-magnifying-glass search-icon"></i>
                    <input type="text" id="searchInput" class="search-input" placeholder="Buscar por tipo, referencia, proveedor...">
                </div>
                <button id="downloadBtn" class="btn btn-primary"><i class="fa-solid fa-file-excel"></i> Exportar a Excel</button>
            </div>
            <div id="tableContainer" class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th data-sort="tipo_de_tela">Tipo de Tela <span class="sort-indicator"></span></th>
                            <th data-sort="referencia_de_tela">Referencia <span class="sort-indicator"></span></th>
                            <th data-sort="proveedor">Proveedor <span class="sort-indicator"></span></th>
                            <th>Color</th>
                            <th data-sort="cantidad_value">Cantidad <span class="sort-indicator"></span></th>
                            <th data-sort="size_value">Tamaño <span class="sort-indicator"></span></th>
                            <th data-sort="entry_date">Fecha Ingreso <span class="sort-indicator"></span></th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </main>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const API_URL = 'https://damar-app.onrender.com';
        let masterData = [];
        let sortState = { column: 'entry_date', direction: 'desc' };

        const searchInput = document.getElementById('searchInput');
        const tableBody = document.getElementById('tableBody');
        const tableHeaders = document.querySelectorAll('.data-table thead th');

        async function apiRequest(endpoint, method = 'GET', data = null) {
            try {
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'ngrok-skip-browser-warning': 'true',
                    },
                    mode: 'cors',
                };
                if (data) options.body = JSON.stringify(data);
                
                const response = await fetch(`${API_URL}${endpoint}`, options);
                 if (response.headers.get("content-type")?.includes("application/vnd.openxmlformats-officedocument.spreadsheetml.sheet")) {
                    return response.blob();
                }
                
                const responseText = await response.text();
                let responseData;
                try {
                    responseData = JSON.parse(responseText.replace(/:NaN/g, ':null'));
                } catch (e) {
                    throw new Error(`Error al procesar JSON: ${responseText}`);
                }
                if (!response.ok) throw new Error(responseData.message || 'Error del servidor');
                return responseData;
            } catch (error) {
                console.error('API Request Error:', error);
                throw error;
            }
        }

        function renderTable(data) {
            tableBody.innerHTML = '';
            if (data.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="7" class="feedback-state"><i class="fa-solid fa-box-open"></i> No se encontraron registros.</td></tr>`;
                return;
            }
            const rows = data.map(item => `
                <tr>
                    <td>${item.tipo_de_tela || ''}</td>
                    <td>${item.referencia_de_tela || ''}</td>
                    <td>${item.proveedor || ''}</td>
                    <td><div class="color-cell" style="background-image: url(${item.color_image_path || ''});"></div></td>
                    <td>${item.cantidad_value || 0} ${item.cantidad_type || ''}</td>
                    <td>${item.size_value || 0} ${item.size_unit || ''}</td>
                    <td>${item.entry_date || ''}</td>
                </tr>
            `).join('');
            tableBody.innerHTML = rows;
        }

        function applyFiltersAndSort() {
            const searchTerm = searchInput.value.toLowerCase().trim();
            let filteredData = masterData.filter(item => {
                return !searchTerm ||
                    (item.tipo_de_tela || '').toLowerCase().includes(searchTerm) ||
                    (item.referencia_de_tela || '').toLowerCase().includes(searchTerm) ||
                    (item.proveedor || '').toLowerCase().includes(searchTerm);
            });

            filteredData.sort((a, b) => {
                const aVal = a[sortState.column] || '';
                const bVal = b[sortState.column] || '';
                const comparison = String(aVal).localeCompare(String(bVal), undefined, { numeric: true });
                return sortState.direction === 'asc' ? comparison : -comparison;
            });
            
            updateSortIndicators();
            renderTable(filteredData);
        }
        
        function updateSortIndicators() {
            tableHeaders.forEach(th => {
                th.classList.remove('sorted');
                const indicator = th.querySelector('.sort-indicator');
                if (indicator) indicator.innerHTML = '';
            });

            const activeHeader = document.querySelector(`th[data-sort="${sortState.column}"]`);
            if (activeHeader) {
                activeHeader.classList.add('sorted');
                const indicator = activeHeader.querySelector('.sort-indicator');
                if (indicator) indicator.innerHTML = sortState.direction === 'asc' ? '▲' : '▼';
            }
        }

        async function loadInitialData() {
            tableBody.innerHTML = `<tr><td colspan="7"><div class="loading-spinner"></div></td></tr>`;
            try {
                // CORRECCIÓN: La API devuelve { "fabrics": [...] }, no una lista directa.
                const response = await apiRequest('/fabrics');
                masterData = response.fabrics || response; // Se ajusta para aceptar ambas respuestas.
                applyFiltersAndSort();
            } catch (error) {
                tableBody.innerHTML = `<tr><td colspan="7" class="feedback-state"><i class="fa-solid fa-circle-exclamation"></i> Error al cargar datos.</td></tr>`;
            }
        }
        
        async function handleDownload() {
            const btn = document.getElementById('downloadBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Exportando...';
            try {
                const blob = await apiRequest('/fabrics/download');
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `inventario_telas_${new Date().toISOString().split('T')[0]}.xlsx`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();
            } catch (error) {
                alert('Error al generar el archivo Excel.');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-file-excel"></i> Exportar a Excel';
            }
        }

        searchInput.addEventListener('input', applyFiltersAndSort);
        document.getElementById('downloadBtn').addEventListener('click', handleDownload);
        
        tableHeaders.forEach(th => {
            if (th.dataset.sort) {
                th.addEventListener('click', () => {
                    const column = th.dataset.sort;
                    if (sortState.column === column) {
                        sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        sortState.column = column;
                        sortState.direction = 'asc';
                    }
                    applyFiltersAndSort();
                });
            }
        });

        loadInitialData();
    });
    </script>
</body>
</html>
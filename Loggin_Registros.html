<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Usuarios - DAMAR</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        :root {
            --primary-dark: #2C3E50; --secondary-light: #ECF0F1; --accent: #3498DB;
            --text-dark: #34495E; --success: #27AE60; --danger: #E74C3C;
            --border-color: #dfe4ea; --gradient-primary: linear-gradient(135deg, #667eea, #764ba2);
            --shadow: 0 10px 30px rgba(44, 62, 80, 0.1); --font-family: 'Poppins', sans-serif;
            --border-radius-lg: 12px; --border-radius-md: 8px;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: var(--font-family); background-color: var(--secondary-light); color: var(--text-dark); animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .container { max-width: 1300px; margin: 2rem auto; padding: 0 1.5rem; }
        .card { background-color: white; border-radius: var(--border-radius-lg); padding: 2.5rem; margin-bottom: 2rem; box-shadow: var(--shadow); border: 1px solid var(--border-color); }
        .content-header { text-align: center; margin-bottom: 2.5rem; }
        .content-title { font-size: 2.5rem; font-weight: 700; color: var(--primary-dark); margin-bottom: 0.5rem; }
        .content-subtitle { font-size: 1.1rem; color: var(--text-dark); max-width: 600px; margin: 0 auto; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1.5rem; }
        .form-group { display: flex; flex-direction: column; }
        .form-label { font-weight: 600; margin-bottom: 0.6rem; color: var(--primary-dark); font-size: 0.9rem; }
        .form-input, .form-select { width: 100%; padding: 12px 16px; border: 1px solid var(--border-color); border-radius: var(--border-radius-md); font-size: 1rem; transition: all 0.3s ease; }
        .form-input:focus, .form-select:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.15); }
        .buttons-container { display: flex; flex-wrap: wrap; gap: 1rem; margin-top: 2rem; border-top: 1px solid var(--border-color); padding-top: 2rem; }
        .btn { border: none; border-radius: var(--border-radius-md); padding: 12px 24px; font-size: 0.95rem; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 0.75rem; transition: all 0.3s ease; text-transform: uppercase; }
        .btn:disabled { background-color: #bdc3c7; cursor: not-allowed; opacity: 0.6; }
        .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 15px 35px rgba(44, 62, 80, 0.15); }
        .btn-primary { background: var(--gradient-primary); color: white; }
        .btn-success { background-color: var(--success); color: white; }
        .btn-danger { background-color: var(--danger); color: white; }
        .btn-secondary { background-color: var(--secondary-light); color: var(--text-dark); border: 1px solid var(--border-color); }
        .table-container { overflow-x: auto; }
        .data-table { width: 100%; border-collapse: collapse; text-align: left; }
        .data-table th, .data-table td { padding: 16px 20px; vertical-align: middle; border-bottom: 1px solid var(--border-color); }
        .data-table thead th { background-color: #f8f9fa; color: var(--primary-dark); font-size: 13px; font-weight: 600; text-transform: uppercase; }
        .data-table tbody tr:hover { background-color: #f5f5f5; cursor: pointer; }
        .data-table tr.selected { background-color: rgba(52, 152, 219, 0.1) !important; box-shadow: inset 4px 0 0 0 var(--accent); }
        .feedback-state { text-align: center; padding: 4rem 1rem; font-size: 1.1rem; color: #6c757d; }
        .feedback-state i { font-size: 2.5rem; display: block; margin-bottom: 1rem; color: var(--accent); }
        .loading-spinner { width: 50px; height: 50px; border: 4px solid var(--border-color); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 1050; }
        .toast { display: flex; align-items: center; padding: 15px 20px; border-radius: var(--border-radius-md); color: white; font-weight: 500; margin-bottom: 10px; box-shadow: var(--shadow); transform: translateX(120%); animation: slideIn 0.5s forwards; }
        .toast.success { background-color: var(--success); }
        .toast.error { background-color: var(--danger); }
        @keyframes slideIn { to { transform: translateX(0); } }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s ease; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-content { background: white; padding: 2rem; border-radius: var(--border-radius-lg); width: 90%; max-width: 450px; text-align: center; transform: scale(0.9); transition: all 0.3s ease; }
        .modal-overlay.active .modal-content { transform: scale(1); }
    </style>
</head>
<body>
    <div id="toastContainer" class="toast-container"></div>
    <div id="confirmModal" class="modal-overlay">
        <div class="modal-content">
            <h3>Confirmar Acción</h3>
            <p id="modalMessage">¿Estás seguro?</p>
            <div style="display: flex; justify-content: center; gap: 1rem;">
                <button id="modalCancelBtn" class="btn btn-secondary">Cancelar</button>
                <button id="modalConfirmBtn" class="btn btn-danger">Confirmar</button>
            </div>
        </div>
    </div>
    
    <div class="container">
        <header class="content-header">
            <h1 class="content-title">Gestión de Usuarios del Sistema</h1>
            <p class="content-subtitle">Cree, modifique y elimine los usuarios que tienen acceso al sistema y asigne sus roles.</p>
        </header>
        <main>
            <section class="card">
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label" for="userInput">Usuario</label>
                        <input type="text" id="userInput" class="form-input" placeholder="ej: jgarcia" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="passwordInput">Contraseña</label>
                        <input type="password" id="passwordInput" class="form-input" placeholder="Requerida para usuarios nuevos">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="roleSelect">Rol</label>
                        <select id="roleSelect" class="form-select" required>
                            <option value="" disabled selected>Seleccione un rol...</option>
                            <option value="Administrador">Administrador</option>
                            <option value="Almacenista">Almacenista</option>
                            <option value="Corte">Corte</option>
                            <option value="Satelite">Satélite</option>
                            <option value="Ventas">Ventas</option>
                        </select>
                    </div>
                </div>
                <div class="buttons-container">
                    <button id="addBtn" class="btn btn-primary"><i class="fa-solid fa-user-plus"></i> Agregar</button>
                    <button id="editBtn" class="btn btn-success"><i class="fa-solid fa-user-pen"></i> Editar</button>
                    <button id="deleteBtn" class="btn btn-danger"><i class="fa-solid fa-user-xmark"></i> Eliminar</button>
                    <button id="clearBtn" class="btn btn-secondary"><i class="fa-solid fa-eraser"></i> Limpiar</button>
                </div>
            </section>
            
            <section class="card">
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Usuario</th>
                                <th>Contraseña (Visible)</th>
                                <th>Rol</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody"></tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let API_URL = 'https://damar-app.onrender.com'; 
            try {
                if (window.parent && window.parent.API_BASE_URL) {
                    API_URL = window.parent.API_BASE_URL;
                }
            } catch (e) {
                console.warn('No se pudo acceder a window.parent. Usando URL por defecto.');
            }

            let selectedUsername = null;

            const userInput = document.getElementById('userInput');
            const passwordInput = document.getElementById('passwordInput');
            const roleSelect = document.getElementById('roleSelect');
            const tableBody = document.getElementById('usersTableBody');
            const apiButtons = [document.getElementById('addBtn'), document.getElementById('editBtn'), document.getElementById('deleteBtn')];

            const showToast = (message, type = 'success') => {
                const toastContainer = document.getElementById('toastContainer');
                if (!toastContainer) {
                    console.error('Toast container not found');
                    return;
                }
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-times-circle'}"></i> ${message}`;
                toastContainer.appendChild(toast);
                setTimeout(() => toast.remove(), 4000);
            };

            const showConfirmation = (message, onConfirm) => {
                const confirmModal = document.getElementById('confirmModal');
                document.getElementById('modalMessage').textContent = message;
                confirmModal.classList.add('active');
                const close = () => {
                    confirmModal.classList.remove('active');
                    document.getElementById('modalConfirmBtn').onclick = null;
                    document.getElementById('modalCancelBtn').onclick = null;
                };
                document.getElementById('modalConfirmBtn').onclick = () => { close(); onConfirm(); };
                document.getElementById('modalCancelBtn').onclick = close;
            };

            const setButtonsLoading = (loading) => {
                apiButtons.forEach(btn => btn.disabled = loading);
            };

            async function apiRequest(endpoint, method = 'GET', data = null) {
                setButtonsLoading(true);
                try {
                    const options = {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json',
                            'ngrok-skip-browser-warning': 'true',
                        },
                        mode: 'cors',
                    };
                    if (data) {
                        options.body = JSON.stringify(data);
                    }
                    const response = await fetch(`${API_URL}${endpoint}`, options);
                    const responseData = await response.json();
                    if (!response.ok) {
                        throw new Error(responseData.message || 'Error en la respuesta del servidor');
                    }
                    return responseData;
                } catch (error) {
                    showToast(error.message, 'error');
                    throw error;
                } finally {
                    setButtonsLoading(false);
                }
            }

            const renderTable = (state, message = '', data = []) => {
                let content = '';
                if (state === 'loading') {
                    content = `<tr><td colspan="3" class="feedback-state"><div class="loading-spinner"></div></td></tr>`;
                } else if (state === 'error') {
                    content = `<tr><td colspan="3" class="feedback-state"><i class="fa-solid fa-circle-exclamation"></i> ${message}</td></tr>`;
                } else if (!data || data.length === 0) {
                    content = `<tr><td colspan="3" class="feedback-state">No hay usuarios registrados.</td></tr>`;
                } else {
                    // CORRECCIÓN: Se cambiaron las propiedades a minúsculas para que coincidan con la API.
                    data.forEach((user) => {
                        content += `<tr onclick="selectUserRow(this, '${user.usuario}', '${user.rol}')">
                                      <td>${user.usuario}</td>
                                      <td>${user.contraseña}</td>
                                      <td>${user.rol}</td>
                                    </tr>`;
                    });
                }
                tableBody.innerHTML = content;
            };

            const loadUsers = async () => {
                renderTable('loading');
                try {
                    const response = await apiRequest('/users');
                    // CORRECCIÓN: Se verifica si los datos vienen en una propiedad "users" o directamente.
                    const users = response.users || response;
                    renderTable('success', '', users);
                } catch (error) {
                    renderTable('error', 'No se pudieron cargar los usuarios.');
                }
            };
            
            const clearForm = () => {
                selectedUsername = null;
                userInput.value = '';
                passwordInput.value = '';
                roleSelect.value = '';
                userInput.disabled = false;
                passwordInput.placeholder = 'Requerida para usuarios nuevos';
                document.getElementById('editBtn').innerHTML = '<i class="fa-solid fa-user-pen"></i> Editar';
                Array.from(tableBody.children).forEach(row => row.classList.remove('selected'));
            };

            // CORRECCIÓN: Se ajustó la función para que los parámetros coincidan con los datos.
            window.selectUserRow = (rowElement, usuario, rol) => {
                selectedUsername = usuario;
                userInput.value = usuario;
                roleSelect.value = rol;
                passwordInput.value = ''; 
                passwordInput.placeholder = 'Dejar en blanco para no cambiar';
                userInput.disabled = true;
                document.getElementById('editBtn').innerHTML = '<i class="fa-solid fa-save"></i> Guardar Cambios';
                
                Array.from(tableBody.children).forEach(row => row.classList.remove('selected'));
                rowElement.classList.add('selected');
            };

            document.getElementById('addBtn').addEventListener('click', async () => {
                // CORRECCIÓN: Se envían las propiedades en minúscula a la API.
                const data = { 
                    usuario: userInput.value.trim(), 
                    contraseña: passwordInput.value.trim(), 
                    rol: roleSelect.value 
                };
                if (!data.usuario || !data.contraseña || !data.rol) {
                    return showToast('Usuario, contraseña y rol son obligatorios.', 'error');
                }
                try {
                    const result = await apiRequest('/users', 'POST', data);
                    showToast(result.message, 'success');
                    clearForm();
                    loadUsers();
                } catch (error) {}
            });

            document.getElementById('editBtn').addEventListener('click', async () => {
                if (!selectedUsername) return showToast('Seleccione un usuario para editar.', 'error');
                
                // CORRECCIÓN: Se envían las propiedades en minúscula a la API.
                const data = { rol: roleSelect.value };
                const newPassword = passwordInput.value.trim();
                if (newPassword) {
                    data.contraseña = newPassword;
                }
                if (!data.rol) return showToast('Debe seleccionar un nuevo rol.', 'error');

                try {
                    const result = await apiRequest(`/users/${selectedUsername}`, 'PUT', data);
                    showToast(result.message, 'success');
                    clearForm();
                    loadUsers();
                } catch (error) {}
            });

            document.getElementById('deleteBtn').addEventListener('click', () => {
                if (!selectedUsername) return showToast('Seleccione un usuario para eliminar.', 'error');
                showConfirmation(`¿Seguro que desea eliminar al usuario "${selectedUsername}"? Esta acción no se puede deshacer.`, async () => {
                    try {
                        const result = await apiRequest(`/users/${selectedUsername}`, 'DELETE');
                        showToast(result.message, 'success');
                        clearForm();
                        loadUsers();
                    } catch (error) {}
                });
            });

            document.getElementById('clearBtn').addEventListener('click', clearForm);

            loadUsers();
        });
    </script>
</body>
</html>